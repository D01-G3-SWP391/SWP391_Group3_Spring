<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n ·ª©ng tuy·ªÉn c·ªßa t√¥i - JOB4YOU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/navbarStudent.css}"/>
    <link rel="stylesheet" th:href="@{/css/my-applications.css}"/>
    <link rel="stylesheet" th:href="@{/css/language_sidebar.css}" />

    <!-- üí¨ Chat System CSS -->
    <style>
        /* Modern Chat System for Student - Based on Employer Design */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .chat-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .chat-offcanvas {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 9999;
            display: flex;
            flex-direction: column;
        }

        .chat-offcanvas.show {
            right: 0;
        }

        /* Chat Header */
        .chat-header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-header .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            margin-right: 10px;
            border-radius: 50%;
            transition: background 0.2s;
            display: none;
        }

        .chat-header .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-header .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .chat-header .info h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-header .info p {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }

        .chat-header .close-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        /* Chat Input */
        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-group {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 8px 15px;
        }

        .chat-input-group input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            padding: 8px 0;
            font-size: 14px;
        }

        .chat-input-group button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-input-group button:hover {
            transform: scale(1.05);
        }

        /* Chat Button in Applications */
        .chat-employer-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .chat-employer-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .chat-employer-btn i {
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-offcanvas {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
<div th:replace="~{navbar/navbarStudent :: navbarStudent}"></div>

<div class="main-content">
    <div class="page-header">
        <div class="header-content" style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center;">
                <div class="header-icon">
                    <i class="bi bi-briefcase-fill"></i>
                </div>
                <div style="margin-left: 15px;">
                    <h1>ƒê∆°n ·ª©ng tuy·ªÉn c·ªßa t√¥i</h1>
                    <p>Theo d√µi tr·∫°ng th√°i c√°c ƒë∆°n ·ª©ng tuy·ªÉn</p>
                </div>
            </div>
        
        </div>
    </div>

    <div class="applications-container" th:if="${applications != null and !#lists.isEmpty(applications)}">
        <!-- Table Header -->
        <div class="table-header">
            <div class="header-cell job-title-col">
                <i class="bi bi-briefcase"></i>
                <span>C√îNG VI·ªÜC</span>
            </div>
            <div class="header-cell company-col">
                <i class="bi bi-building"></i>
                <span>C√îNG TY</span>
            </div>
            <div class="header-cell location-col">
                <i class="bi bi-geo-alt"></i>
                <span>ƒê·ªäA ƒêI·ªÇM</span>
            </div>
            <div class="header-cell date-col">
                <i class="bi bi-calendar-check"></i>
                <span>NG√ÄY ·ª®NG TUY·ªÇN</span>
            </div>
            <div class="header-cell status-col">
                <i class="bi bi-flag"></i>
                <span>TR·∫†NG TH√ÅI</span>
            </div>
            <div class="header-cell action-col">
                <i class="bi bi-gear"></i>
                <span>THAO T√ÅC</span>
            </div>
        </div>

        <!-- Application Rows Container -->
        <div id="applications-list">
            <div th:each="jobApp, iterStat : ${applications}"
                 class="application-row"
                 th:data-index="${iterStat.index}"
                 style="display: none;">

                <!-- Basic Info Row -->
                <div class="basic-row">
                    <div class="cell job-title-col">
                        <div class="job-info-cell">
                            <i class="bi bi-briefcase-fill job-icon"></i>
                            <span class="job-title" th:text="${jobApp.jobPost?.jobTitle ?: 'N/A'}"></span>
                        </div>
                    </div>
                    <div class="cell company-col">
                        <div class="company-info">
                            <i class="bi bi-building-fill company-icon"></i>
                            <span th:text="${jobApp.jobPost?.employer?.companyName ?: 'Ch∆∞a c√≥ th√¥ng tin'}"></span>
                        </div>
                    </div>
                    <div class="cell location-col">
                        <div class="location-info">
                            <i class="bi bi-geo-alt-fill location-icon"></i>
                            <span th:text="${jobApp.jobPost?.jobLocation ?: 'N/A'}"></span>
                        </div>
                    </div>
                    <div class="cell date-col">
                        <div class="date-info">
                            <i class="bi bi-calendar-check-fill date-icon"></i>
                            <span th:text="${jobApp.appliedAt != null ? #temporals.format(jobApp.appliedAt, 'dd/MM/yyyy') : 'N/A'}"></span>
                        </div>
                    </div>
                    <div class="cell status-col">
                        <span class="status-badge"
                              th:class="'status-badge status-' + ${jobApp.status?.name()?.toLowerCase() ?: 'unknown'}"
                              th:text="${jobApp.status?.name() ?: 'UNKNOWN'}"></span>
                    </div>
                    <div class="cell action-col">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <!-- üí¨ Chat Button -->
                            <button class="chat-employer-btn"
                                    th:data-employer-email="${jobApp.jobPost?.employer?.account?.email ?: ''}"
                                    th:data-employer-name="${jobApp.jobPost?.employer?.companyName ?: 'Nh√† tuy·ªÉn d·ª•ng'}"
                                    onclick="openChatWithEmployerFromButton(this)"
                                    title="Nh·∫Øn tin v·ªõi nh√† tuy·ªÉn d·ª•ng">
                                <i class="bi bi-chat-dots"></i>
                                <span>Chat</span>
                            </button>

                            <button class="view-details-btn" th:onclick="'toggleDetails(' + ${iterStat.index} + ')'">
                                <i class="bi bi-chevron-down"></i>
                                <span>Chi ti·∫øt</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Detailed Info Row (Hidden by default) -->
                <div class="details-row" th:id="'details-' + ${iterStat.index}">
                    <div class="details-content">
                        <div class="details-grid">
                            <!-- Personal Info Section -->
                            <div class="detail-section">
                                <h4><i class="bi bi-person-fill"></i> Th√¥ng tin c√° nh√¢n</h4>
                                <div class="detail-items">
                                    <div class="detail-item" th:if="${jobApp.fullName}">
                                        <span class="label"><i class="bi bi-person-badge"></i> H·ªç t√™n:</span>
                                        <span class="value" th:text="${jobApp.fullName}"></span>
                                    </div>
                                    <div class="detail-item" th:if="${jobApp.email}">
                                        <span class="label"><i class="bi bi-envelope"></i> Email:</span>
                                        <span class="value" th:text="${jobApp.email}"></span>
                                    </div>
                                    <div class="detail-item" th:if="${jobApp.phone}">
                                        <span class="label"><i class="bi bi-telephone"></i> ƒêi·ªán tho·∫°i:</span>
                                        <span class="value" th:text="${jobApp.phone}"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Info Section -->
                            <div class="detail-section">
                                <h4><i class="bi bi-briefcase-fill"></i> Th√¥ng tin c√¥ng vi·ªác</h4>
                                <div class="detail-items">
                                    <div class="detail-item">
                                        <span class="label"><i class="bi bi-clock"></i> Th·ªùi gian ·ª©ng tuy·ªÉn:</span>
                                        <span class="value" th:text="${jobApp.appliedAt != null ? #temporals.format(jobApp.appliedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label"><i class="bi bi-geo-alt"></i> ƒê·ªãa ƒëi·ªÉm:</span>
                                        <span class="value" th:text="${jobApp.jobPost?.jobLocation ?: 'N/A'}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Application Description -->
                        <div class="application-description" th:if="${jobApp.description != null and !#strings.isEmpty(jobApp.description)}">
                            <h4><i class="bi bi-chat-text-fill"></i> N·ªôi dung ·ª©ng tuy·ªÉn</h4>
                            <div class="description-content">
                                <p th:text="${jobApp.description}"></p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="detail-actions">
                            <a th:href="@{/JobDescription/JobPost(id=${jobApp.jobPost?.jobPostId ?: 0})}"
                               class="btn btn-primary" th:if="${jobApp.jobPost}">
                                <i class="bi bi-eye-fill"></i>
                                <span>Xem c√¥ng vi·ªác</span>
                            </a>
                        </div>
                        <!-- Hi·ªÉn th·ªã CV tr·ª±c ti·∫øp b·∫±ng iframe ho·∫∑c img n·∫øu c√≥ -->
                        <div th:if="${jobApp.cvUrl != null and !#strings.isEmpty(jobApp.cvUrl)}" style="text-align: center; margin: 0 auto; max-width: 800px;">
                            <img th:if="${#strings.endsWith(jobApp.cvUrl, '.jpg') or #strings.endsWith(jobApp.cvUrl, '.jpeg') or #strings.endsWith(jobApp.cvUrl, '.png') or #strings.endsWith(jobApp.cvUrl, '.gif')}"
                                 th:src="${jobApp.cvUrl}" alt="CV Image" style="max-width:100%; max-height:800px; display:block; margin:0 auto; border-radius: 8px; box-shadow: 0 4px 16px rgba(80,37,196,0.12);"/>

                            <!-- PDF Preview -->
                            <iframe th:if="${!(#strings.endsWith(jobApp.cvUrl, '.jpg') or #strings.endsWith(jobApp.cvUrl, '.jpeg') or #strings.endsWith(jobApp.cvUrl, '.png') or #strings.endsWith(jobApp.cvUrl, '.gif'))}"
                                    th:src="'https://docs.google.com/viewer?url=' + ${jobApp.cvUrl} + '&embedded=true'"
                                    style="width:100%; height:800px; border:none; border-radius: 8px; box-shadow: 0 4px 16px rgba(80,37,196,0.12);">
                            </iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
            <div class="pagination-wrapper">
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" th:if="${applications == null or #lists.isEmpty(applications)}">
        <div class="empty-illustration">
            <i class="bi bi-briefcase-x"></i>
        </div>
        <h3>Ch∆∞a c√≥ ƒë∆°n ·ª©ng tuy·ªÉn n√†o</h3>
        <p>H√£y t√¨m ki·∫øm v√† ·ª©ng tuy·ªÉn c√°c c√¥ng vi·ªác ph√π h·ª£p v·ªõi b·∫°n</p>
    </div>
</div>

<!-- üí¨ Modern Chat UI for Student -->
<div id="chatOverlay" class="chat-overlay" onclick="closeChat()"></div>
<div id="chatOffcanvas" class="chat-offcanvas">
    <!-- Chat Header -->
    <div class="chat-header">
        <button id="chatBackBtn" class="back-btn" onclick="goBackToRooms()">
            <i class="bi bi-arrow-left"></i>
        </button>
        <div id="chatAvatar" class="avatar">üí¨</div>
        <div class="info">
            <h4 id="chatName">Tin nh·∫Øn</h4>
            <p id="chatStatus">Ch·ªçn cu·ªôc tr√≤ chuy·ªán</p>
        </div>
        <button class="close-btn" onclick="closeChat()">
            <i class="bi bi-x"></i>
        </button>
    </div>

    <!-- Chat Messages Area -->
    <div id="chatMessages" class="chat-messages">
        <!-- Messages will be loaded here -->
    </div>

    <!-- Chat Input -->
    <div class="chat-input">
        <form id="messageForm" onsubmit="sendMessage(event)">
            <div class="chat-input-group">
                <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="1000" disabled>
                <button type="submit" disabled>
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- üí¨ Set current user for chat system -->
<script th:inline="javascript">
    window.currentUserId = /*[[${account?.userId}]]*/ null;
    window.currentUserName = /*[[${account?.fullName}]]*/ 'Student';
    window.currentUserRole = 'STUDENT';
    window.currentChatRoomId = null;

    console.log('üîç Student Chat - currentUserId:', window.currentUserId);
    console.log('üîç Student Chat - currentUserName:', window.currentUserName);
</script>

<!-- üí¨ Chat System JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@6.1.2/bundles/stomp.umd.min.js"></script>

<script>
    // üí¨ Chat WebSocket Client
    let chatWebSocketClient = null;
    let currentChatRoomId = null;

    // Initialize WebSocket connection
    function initChatWebSocket() {
        if (!window.currentUserId) {
            console.warn('No user ID found, chat disabled');
            return;
        }

        try {
            const socket = new SockJS('/ws');
            chatWebSocketClient = new StompJs.Client({
                webSocketFactory: () => socket,
                debug: function (str) {
                    console.log('üîç STOMP:', str);
                },
                onConnect: function (frame) {
                    console.log('‚úÖ Chat WebSocket connected successfully!');

                    // Personal messages subscription removed to avoid duplicates
                    // We'll only use room-specific subscriptions
                },
                onStompError: function (frame) {
                    console.error('‚ùå STOMP error:', frame);
                },
                onDisconnect: function () {
                    console.log('üîå Chat WebSocket disconnected');
                }
            });

            chatWebSocketClient.activate();
        } catch (error) {
            console.error('‚ùå Failed to connect WebSocket:', error);
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (window.currentUserId) {
            initChatWebSocket();
        }
    });

    /**
     * üì° Subscribe to room messages
     */
    function subscribeToRoomMessages(roomId) {
        if (!chatWebSocketClient || !chatWebSocketClient.connected) {
            console.warn('WebSocket not connected, cannot subscribe to room messages');
            return;
        }

        console.log('üì° Subscribing to room messages for room:', roomId);

        // Subscribe to room specific messages
        chatWebSocketClient.subscribe(`/topic/chat/${roomId}`, function(message) {
            console.log('üì® Received room message:', message);
            const messageData = JSON.parse(message.body);
            handleNewMessage(messageData);
        });
    }

    /**
     * ‚úÖ Mark messages as read
     */
    function markMessagesAsRead(roomId) {
        if (!chatWebSocketClient || !chatWebSocketClient.connected) {
            console.warn('WebSocket not connected, cannot mark messages as read');
            return;
        }

        console.log('‚úÖ Marking messages as read for room:', roomId);

        // Send mark as read via WebSocket
        chatWebSocketClient.publish({
            destination: '/app/chat.markRead',
            body: JSON.stringify({
                chatRoomId: Number(roomId),
                userId: window.currentUserId
            })
        });
    }

    /**
     * üéØ M·ªü chat tr·ª±c ti·∫øp v·ªõi employer
     */
    function openChatWithEmployer(employerEmail, employerName) {
        console.log('üéØ Opening chat with employer:', employerName, employerEmail);

        if (!employerEmail || !window.currentUserId) {
            alert('Kh√¥ng th·ªÉ m·ªü chat. Vui l√≤ng th·ª≠ l·∫°i.');
            return;
        }

        // Update chat header
        document.getElementById('chatName').textContent = employerName;
        document.getElementById('chatAvatar').textContent = employerName.charAt(0).toUpperCase();
        document.getElementById('chatStatus').textContent = 'ƒêang ho·∫°t ƒë·ªông';

        // Show chat panel
        document.getElementById('chatOverlay').classList.add('show');
        document.getElementById('chatOffcanvas').classList.add('show');

        // Hide back button since we're going directly to chat
        const backBtn = document.getElementById('chatBackBtn');
        if (backBtn) {
            backBtn.style.display = 'none';
        }

        // Try to create or find chat room with this employer
        createChatWithEmployer(employerEmail, employerName);
    }

    /**
     * üõ†Ô∏è Helper function to extract data from button and call openChatWithEmployer
     */
    function openChatWithEmployerFromButton(button) {
        const employerEmail = button.getAttribute('data-employer-email');
        const employerName = button.getAttribute('data-employer-name');
        openChatWithEmployer(employerEmail, employerName);
    }

    /**
     * üìã Hi·ªÉn th·ªã danh s√°ch t·∫•t c·∫£ chat rooms
     */
    function showAllChatRooms() {
        console.log('üìã Opening chat rooms list');

        // Update header for rooms list
        document.getElementById('chatName').textContent = 'Tin nh·∫Øn';
        document.getElementById('chatAvatar').textContent = 'üí¨';
        document.getElementById('chatStatus').textContent = 'Ch·ªçn cu·ªôc tr√≤ chuy·ªán';

        // Hide back button for rooms list
        const backBtn = document.getElementById('chatBackBtn');
        if (backBtn) {
            backBtn.style.display = 'none';
        }

        // Show chat panel
        document.getElementById('chatOverlay').classList.add('show');
        document.getElementById('chatOffcanvas').classList.add('show');

        // Load all chat rooms
        loadAllChatRooms();
    }

    /**
     * üîç T·∫°o ho·∫∑c t√¨m chat room v·ªõi employer
     */
    async function createChatWithEmployer(employerEmail, employerName) {
        try {
            console.log('üîç Finding employer by email:', employerEmail);

            // First, try to find existing chat rooms
            const roomsResponse = await fetch('/api/chat/rooms');
            if (roomsResponse.ok) {
                const rooms = await roomsResponse.json();
                console.log('üìã Existing rooms:', rooms);

                // Try to find a room for this employer
                const existingRoom = rooms.find(room =>
                    room.otherParticipantName &&
                    (room.otherParticipantName.toLowerCase().includes(employerName.toLowerCase()) ||
                        room.otherParticipantName.includes(employerEmail.split('@')[0]))
                );

                if (existingRoom) {
                    console.log('‚úÖ Found existing room:', existingRoom);
                    currentChatRoomId = String(existingRoom.chatRoomId);

                    // Join WebSocket room
                    if (chatWebSocketClient && chatWebSocketClient.connected) {
                        // Subscribe to room messages
                        subscribeToRoomMessages(currentChatRoomId);

                        chatWebSocketClient.publish({
                            destination: '/app/chat.joinRoom',
                            body: JSON.stringify({ chatRoomId: Number(currentChatRoomId) })
                        });
                    }

                    // Load chat history AND enable input/UI
                    showReadyChatInterface(employerName);
                    return;
                }
            }

            // If no existing room found, try to CREATE REAL chat room
            console.log('üèóÔ∏è No existing room found, creating REAL chat room for:', employerName, employerEmail);
            await createRealChatRoomWithEmployer(employerName, employerEmail);

        } catch (error) {
            console.error('Error finding/creating chat room:', error);
            createNewChatSession(employerName, employerEmail);
        }
    }

    /**
     * üèóÔ∏è T·∫°o chat room th·∫≠t qua API
     */
    async function createRealChatRoomWithEmployer(employerName, employerEmail) {
        try {
            console.log('üèóÔ∏è Creating REAL chat room via API for:', employerName, employerEmail);

            // Try to find employer ID by email first
            const employerResponse = await fetch(`/api/employers/findByEmail?email=${encodeURIComponent(employerEmail)}`);

            let employerUserId = null;
            if (employerResponse.ok) {
                const employerData = await employerResponse.json();
                employerUserId = employerData.userId; // Use Account.userId
                console.log('üë§ Found employer data:', employerData);
                console.log('üë§ Using employer userId:', employerUserId);
            }

            if (!employerUserId) {
                console.warn('‚ö†Ô∏è Could not find employer userId, creating demo session');
                createNewChatSession(employerName, employerEmail);
                return;
            }

            // Create real chat room via API
            const createRoomResponse = await fetch('/api/chat/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    studentId: window.currentUserId,   // Student's Account.userId
                    employerId: employerUserId,        // Employer's Account.userId
                    jobPostId: null                    // General chat, not job-specific
                })
            });

            if (createRoomResponse.ok) {
                const newRoom = await createRoomResponse.json();
                console.log('‚úÖ Successfully created real chat room:', newRoom);

                currentChatRoomId = String(newRoom.chatRoomId);

                // Join WebSocket room
                if (chatWebSocketClient && chatWebSocketClient.connected) {
                    // Subscribe to room messages
                    subscribeToRoomMessages(currentChatRoomId);

                    chatWebSocketClient.publish({
                        destination: '/app/chat.joinRoom',
                        body: JSON.stringify({ chatRoomId: Number(currentChatRoomId) })
                    });

                    // Mark messages as read
                    markMessagesAsRead(currentChatRoomId);
                }

                // Show ready chat interface
                showReadyChatInterface(employerName);

            } else {
                console.error('‚ùå Failed to create chat room via API');
                createNewChatSession(employerName, employerEmail);
            }

        } catch (error) {
            console.error('Error creating real chat room:', error);
            createNewChatSession(employerName, employerEmail);
        }
    }

    /**
     * ‚úÖ Hi·ªÉn th·ªã giao di·ªán chat s·∫µn s√†ng
     */
    function showReadyChatInterface(employerName) {
        // LOAD CHAT HISTORY FIRST before showing UI
        console.log('üìú Loading chat history for room:', currentChatRoomId);
        loadChatHistory(currentChatRoomId);

        // Enable input for sending messages
        const messageInput = document.getElementById('messageInput');
        const sendButton = messageInput.nextElementSibling;
        if (messageInput && sendButton) {
            messageInput.placeholder = `Nh·∫≠p tin nh·∫Øn cho ${employerName}...`;
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }

        // Update chat title and status
        document.getElementById('chatName').textContent = `üí¨ ${employerName}`;
        document.getElementById('chatStatus').textContent = 'ƒêang ho·∫°t ƒë·ªông';
        document.getElementById('chatOverlay').classList.add('show');
        document.getElementById('chatOffcanvas').classList.add('show');

        console.log('‚úÖ Chat ready with history for:', employerName);
    }

    /**
     * üìù T·∫°o session chat m·ªõi (fallback)
     */
    function createNewChatSession(employerName, employerEmail) {
        console.log('üìù Creating new chat session for:', employerName, employerEmail);

        const messagesContainer = document.getElementById('chatMessages');

        messagesContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 10px 0;">üí¨ Chat v·ªõi ${employerName}</h5>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">
                        B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán ngay b√¢y gi·ªù!
                    </p>
                </div>
                <div style="color: #999; font-size: 12px;">
                    üí° Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c g·ª≠i real-time
                </div>
            </div>
        `;

        // Enable input for sending messages
        const messageInput = document.getElementById('messageInput');
        const sendButton = messageInput.nextElementSibling;
        if (messageInput && sendButton) {
            messageInput.placeholder = `Nh·∫≠p tin nh·∫Øn cho ${employerName}...`;
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }

        // Set a temporary room ID for this conversation
        currentChatRoomId = 'new_' + employerEmail.replace('@', '_').replace('.', '_');
        console.log('üìù Created new chat session with ID:', currentChatRoomId);
    }

    /**
     * üìã Load t·∫•t c·∫£ chat rooms
     */
    async function loadAllChatRooms() {
        try {
            const response = await fetch('/api/chat/rooms');
            if (!response.ok) {
                throw new Error('Failed to load chat rooms');
            }

            const rooms = await response.json();
            console.log('üìã Loaded chat rooms:', rooms);

            showChatRoomsList(rooms);

        } catch (error) {
            console.error('‚ùå Error loading chat rooms:', error);
            showRoomsError();
        }
    }

    /**
     * üé® Hi·ªÉn th·ªã danh s√°ch chat rooms
     */
    function showChatRoomsList(rooms) {
        const messagesContainer = document.getElementById('chatMessages');

        if (!rooms || rooms.length === 0) {
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                    <h4 style="margin: 0 0 10px 0; color: #333;">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</h4>
                    <p style="margin: 0; font-size: 14px;">
                        C√°c cu·ªôc tr√≤ chuy·ªán v·ªõi nh√† tuy·ªÉn d·ª•ng s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y
                    </p>
                </div>
            `;

            // Disable input for rooms list
            const messageInput = document.getElementById('messageInput');
            const sendButton = messageInput.nextElementSibling;
            if (messageInput && sendButton) {
                messageInput.disabled = true;
                sendButton.disabled = true;
                messageInput.placeholder = 'Ch·ªçn cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ g·ª≠i tin nh·∫Øn...';
            }

            return;
        }

        // Create rooms list HTML
        const roomsHTML = rooms.map(room => {
            const participantName = room.otherParticipantName || 'Nh√† tuy·ªÉn d·ª•ng';
            const lastMessage = room.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn';
            const lastMessageTime = room.lastMessageTime || '';
            const avatar = participantName.charAt(0).toUpperCase();
            const unreadBadge = room.unreadCount > 0 ? `<span style="background: #ff4757; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">${room.unreadCount}</span>` : '';

            return `
                <div class="chat-room-item" onclick="openChatRoom(${room.chatRoomId}, '${participantName}')"
                     style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; border-radius: 8px; margin-bottom: 5px;"
                     onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">

                    <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; font-size: 18px;">
                        ${avatar}
                    </div>

                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <h6 style="margin: 0; font-weight: 600; color: #333; font-size: 15px;">${participantName}</h6>
                            <div style="display: flex; align-items: center;">
                                <small style="color: #666; font-size: 12px;">${lastMessageTime}</small>
                                ${unreadBadge}
                            </div>
                        </div>
                        <p style="margin: 0; color: #666; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${lastMessage}
                        </p>
                    </div>
                </div>
            `;
        }).join('');

        messagesContainer.innerHTML = `
            <div style="padding: 10px;">
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <small style="color: #666; font-size: 12px;">
                        üì± Ch·ªçn cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫Øn tin v·ªõi nh√† tuy·ªÉn d·ª•ng
                    </small>
                </div>
                ${roomsHTML}
            </div>
        `;

        // Disable input for rooms list
        const messageInput = document.getElementById('messageInput');
        const sendButton = messageInput.nextElementSibling;
        if (messageInput && sendButton) {
            messageInput.disabled = true;
            sendButton.disabled = true;
            messageInput.placeholder = 'Ch·ªçn cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ g·ª≠i tin nh·∫Øn...';
        }
    }

    /**
     * üîì M·ªü chat room c·ª• th·ªÉ
     */
    function openChatRoom(roomId, participantName) {
        console.log('üîì Opening chat room:', roomId, 'with participant:', participantName);

        // Update header for individual chat
        document.getElementById('chatName').textContent = participantName;
        document.getElementById('chatAvatar').textContent = participantName.charAt(0).toUpperCase();
        document.getElementById('chatStatus').textContent = 'ƒêang ho·∫°t ƒë·ªông';

        // Show back button for individual chat
        const backBtn = document.getElementById('chatBackBtn');
        if (backBtn) backBtn.style.display = 'inline-block';

        // Set current room
        currentChatRoomId = String(roomId);

        // Join WebSocket room
        if (chatWebSocketClient && chatWebSocketClient.connected) {
            // Subscribe to room messages
            subscribeToRoomMessages(roomId);

            chatWebSocketClient.publish({
                destination: '/app/chat.joinRoom',
                body: JSON.stringify({ chatRoomId: Number(roomId) })
            });

            // Mark messages as read
            markMessagesAsRead(roomId);
        }

        // Load chat history
        loadChatHistory(roomId);

        // Enable input
        const messageInput = document.getElementById('messageInput');
        const sendButton = messageInput.nextElementSibling;
        if (messageInput && sendButton) {
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = `Nh·∫≠p tin nh·∫Øn cho ${participantName}...`;

            // Focus on input
            setTimeout(() => {
                messageInput.focus();
            }, 500);
        }
    }

    /**
     * üìú Load l·ªãch s·ª≠ chat
     */
    function loadChatHistory(roomId) {
        fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load messages');
                }
                return response.json();
            })
            .then(messages => {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';

                const messageList = Array.isArray(messages) ? messages : (messages.content || []);

                messageList.forEach(message => {
                    addMessageToUI(message);
                });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            })
            .catch(error => {
                console.error('Error loading chat history:', error);
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ chat</p>
                        <p><small>B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán b·∫±ng c√°ch g·ª≠i tin nh·∫Øn ƒë·∫ßu ti√™n</small></p>
                    </div>
                `;
            });
    }

    /**
     * üì§ G·ª≠i tin nh·∫Øn
     */
    function sendMessage(event) {
        event.preventDefault();

        const messageInput = document.getElementById('messageInput');
        const messageText = messageInput.value.trim();

        if (!messageText || !currentChatRoomId) return;

        // Handle demo chat sessions (fallback mode)
        if (String(currentChatRoomId).startsWith('new_') || String(currentChatRoomId).startsWith('temp_')) {
            console.log('üì§ Sending message in demo mode');

            addMessageToUI({
                content: messageText,
                senderId: window.currentUserId,
                sentAt: new Date().toISOString(),
                senderName: window.currentUserName
            });

            messageInput.value = '';

            setTimeout(() => {
                addMessageToUI({
                    content: 'Tin nh·∫Øn demo - API t·∫°o chat room th·∫•t b·∫°i.',
                    senderId: 0,
                    sentAt: new Date().toISOString(),
                    senderName: 'Demo'
                });
            }, 1500);

            return;
        }

        // Send via WebSocket for real rooms
        if (chatWebSocketClient && chatWebSocketClient.connected) {
            console.log('üì§ Sending message via WebSocket:', messageText);

            const messageData = {
                chatRoomId: Number(currentChatRoomId),
                content: messageText,
                senderId: window.currentUserId,
                senderType: 'STUDENT'
            };

            chatWebSocketClient.publish({
                destination: '/app/chat.sendMessage',
                body: JSON.stringify(messageData)
            });

            messageInput.value = '';
        } else {
            console.error('‚ùå WebSocket not connected');
            alert('K·∫øt n·ªëi chat b·ªã gi√°n ƒëo·∫°n. Vui l√≤ng refresh trang.');
        }
    }

    /**
     * üí¨ Th√™m tin nh·∫Øn v√†o UI
     */
    function addMessageToUI(message) {
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;

        const isSent = message.senderId == window.currentUserId;
        const messageClass = isSent ? 'sent' : 'received';

        const messageHTML = `
            <div class="message ${messageClass}">
                <div class="message-bubble">
                    ${message.content}
                    <div class="message-time">${formatMessageTime(message.sentAt)}</div>
                </div>
            </div>
        `;

        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    /**
     * üé® Th√™m tin nh·∫Øn v√†o UI
     */
    function addMessageToUI(message) {
        const messagesContainer = document.getElementById('chatMessages');
        const isSent = message.senderId == window.currentUserId;
        const messageClass = isSent ? 'sent' : 'received';
        const senderName = message.senderName || (isSent ? 'B·∫°n' : 'H·ªç');
        const messageTime = formatMessageTime(message.sentAt);

        const messageHTML = `
            <div class="message ${messageClass}">
                <div class="message-bubble">
                    ${message.content}
                    <div class="message-time">${messageTime}</div>
                </div>
            </div>
        `;

        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    /**
     * üì® X·ª≠ l√Ω tin nh·∫Øn m·ªõi t·ª´ WebSocket
     */
    function handleNewMessage(message) {
        console.log('üì® New message received:', message);

        if (currentChatRoomId && message.chatRoomId == Number(currentChatRoomId)) {
            console.log('‚úÖ Adding message to current chat UI');
            addMessageToUI(message);
        }
    }

    /**
     * üïê Format th·ªùi gian tin nh·∫Øn
     */
    function formatMessageTime(timeString) {
        if (!timeString) return '';
        try {
            const date = new Date(timeString);
            return date.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return '';
        }
    }

    /**
     * ‚¨ÖÔ∏è Quay l·∫°i danh s√°ch rooms
     */
    function goBackToRooms() {
        console.log('‚¨ÖÔ∏è Going back to rooms list');

        // Leave current room
        if (chatWebSocketClient && currentChatRoomId) {
            chatWebSocketClient.publish({
                destination: '/app/chat.leaveRoom',
                body: JSON.stringify({ chatRoomId: Number(currentChatRoomId) })
            });
            currentChatRoomId = null;
        }

        // Show rooms list
        showAllChatRooms();
    }

    /**
     * ‚ùå ƒê√≥ng chat
     */
    function closeChat() {
        // Leave WebSocket room
        if (chatWebSocketClient && currentChatRoomId) {
            chatWebSocketClient.publish({
                destination: '/app/chat.leaveRoom',
                body: JSON.stringify({ chatRoomId: Number(currentChatRoomId) })
            });
            currentChatRoomId = null;
        }

        document.getElementById('chatOverlay').classList.remove('show');
        document.getElementById('chatOffcanvas').classList.remove('show');
    }

    /**
     * ‚ö†Ô∏è Hi·ªÉn th·ªã l·ªói rooms
     */
    function showRoomsError() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h4 style="margin: 0 0 10px 0;">Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán</h4>
                <p style="margin: 0 0 20px 0; font-size: 14px;">
                    Vui l√≤ng th·ª≠ l·∫°i sau
                </p>
                <button onclick="loadAllChatRooms()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Th·ª≠ l·∫°i
                </button>
            </div>
        `;
    }
</script>

<script>
    let currentPage = 1;
    const itemsPerPage = 5;
    let totalItems = 0;

    function initializePagination() {
        const applications = document.querySelectorAll('.application-row');
        totalItems = applications.length;

        if (totalItems === 0) return;

        showPage(1);
        setupPagination();
    }

    function showPage(page) {
        const applications = document.querySelectorAll('.application-row');
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        applications.forEach((app, index) => {
            if (index >= startIndex && index < endIndex) {
                app.style.display = 'block';
            } else {
                app.style.display = 'none';
            }
        });

        currentPage = page;
    }

    function setupPagination() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        // Previous button
        const prevBtn = document.createElement('a');
        prevBtn.href = '#';
        prevBtn.innerHTML = '<i class="bi bi-chevron-left"></i>';
        prevBtn.className = 'page-btn prev-btn';
        if (currentPage === 1) prevBtn.classList.add('disabled');
        prevBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                showPage(currentPage - 1);
                setupPagination();
            }
        });
        pagination.appendChild(prevBtn);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('a');
            pageBtn.href = '#';
            pageBtn.textContent = i;
            pageBtn.className = 'page-btn';

            if (i === currentPage) {
                pageBtn.classList.add('active');
            }

            pageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(i);
                setupPagination();
            });

            pagination.appendChild(pageBtn);
        }

        // Next button
        const nextBtn = document.createElement('a');
        nextBtn.href = '#';
        nextBtn.innerHTML = '<i class="bi bi-chevron-right"></i>';
        nextBtn.className = 'page-btn next-btn';
        if (currentPage === totalPages) nextBtn.classList.add('disabled');
        nextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                showPage(currentPage + 1);
                setupPagination();
            }
        });
        pagination.appendChild(nextBtn);
    }

    function toggleDetails(index) {
        const detailsRow = document.getElementById('details-' + index);
        const button = document.querySelector(`[data-index="${index}"] .view-details-btn`);
        const icon = button.querySelector('i');
        const text = button.querySelector('span');

        if (detailsRow.classList.contains('show')) {
            detailsRow.classList.remove('show');
            icon.className = 'bi bi-chevron-down';
            text.textContent = 'Xem chi ti·∫øt';
            button.classList.remove('expanded');
        } else {
            detailsRow.classList.add('show');
            icon.className = 'bi bi-chevron-up';
            text.textContent = '·∫®n chi ti·∫øt';
            button.classList.add('expanded');
        }
    }

    // Initialize pagination when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializePagination();
    });
</script>

<!-- Add notification bell -->
<div th:replace="~{fragments/notification-bell :: notification-bell}"></div>
</body>
<script src="/js/navbarAdmin.js"></script>
<script th:src="@{/js/language-dropdown.js}"></script>


</html>