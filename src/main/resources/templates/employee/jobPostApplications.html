<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Ứng Viên</title>
    <link rel="stylesheet" th:href="@{/css/navbarStudent_Employer.css}"/>
    <link rel="stylesheet" th:href="@{/css/viewListApplication.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarViewJobPost.css}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        .table-container, table, tbody, tr, td { overflow: visible !important; }
        .btn-view-details {
            background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%);
            color: #fff !important;
            border: 2px solid #7c3aed;
            border-radius: 14px;
            font-weight: 600;
            font-size: 1rem;
            padding: 8px 24px;
            box-shadow: 0 2px 8px rgba(80, 37, 196, 0.12);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-view-details:hover, .btn-view-details:focus {
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            color: #fff;
            box-shadow: 0 4px 16px rgba(80, 37, 196, 0.18);
            border-color: #a78bfa;
        }
        .btn-view-details i { font-size: 1.1em; margin-right: 6px; color: #fff !important; }
        .dropdown-menu { position: absolute !important; z-index: 9999 !important; min-width: 12rem !important; max-width: 18rem; white-space: normal; }
        .cell.action-col { min-width: 220px; }
        .status-badge { font-size: 1rem; font-weight: 600; padding: 6px 18px; border-radius: 16px; }
        .btn-view-details { min-width: 120px; }
        .dropdown.dropend { margin-left: 0; }
        tbody tr { margin-bottom: 18px !important; }
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 2rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        thead {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        thead th {
            padding: 20px 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
            position: relative;
        }
        thead th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
        }
        tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        tbody tr:hover {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }
        tbody tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.5);
        }
        tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
        }
        tbody td {
            padding: 18px 16px;
            color: #374151;
            font-weight: 500;
            border: none;
            vertical-align: middle;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            color: white;
        }
        .status-approved {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .status-rejected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
    </style>
</head>
<body>
<div th:replace="~{navbar/navbarEmployee :: navbarAdmin}"></div>
<script src="/js/navbarAdmin.js"></script>

<!-- Modal Gửi Lịch Phỏng Vấn -->
<div class="modal fade" id="interviewModal" tabindex="-1" aria-labelledby="interviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="interviewForm" method="post">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="interviewModalLabel">Gửi lịch phỏng vấn</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="jobPostId" id="modalJobPostId" />
          <div class="mb-3">
            <label>Thời gian phỏng vấn</label>
            <input type="datetime-local" name="interviewTime" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Hình thức</label>
            <select name="interviewType" class="form-control">
              <option value="Online">Online</option>
              <option value="Offline">Offline</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Link meeting (nếu có)</label>
            <input type="text" name="meetingLink" class="form-control">
          </div>
          <div class="mb-3">
            <label>Ghi chú</label>
            <textarea name="note" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Gửi lịch phỏng vấn</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal đổi trạng thái -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="statusForm" method="post">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="statusModalLabel">Đổi trạng thái ứng viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="statusOptions" class="d-flex flex-wrap gap-2"></div>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="main-content">
    <h1 th:text="'Ứng viên cho công việc: ' + ${jobPost.jobTitle}"></h1>
    <p>Tổng số ứng viên: <span th:text="${totalApplications}"></span></p>
    <div class="search-section mb-4">
        <form method="get" class="row g-3">
            <div class="col-md-8">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" name="searchName" class="form-control" placeholder="Tìm kiếm theo tên ứng viên..." th:value="${searchName}">
                </div>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary me-2"><i class="bi bi-search"></i> Tìm kiếm</button>
                <a th:href="@{/Employer/JobPosts/{jobPostId}/applications(jobPostId=${jobPost.jobPostId})}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </a>
            </div>
        </form>
    </div>
    <div class="table-container">
        <div th:if="${applications == null or applications.isEmpty()}" class="empty-state">
            <i class="bi bi-person-x"></i>
            <h3>Chưa có ứng viên nào</h3>
            <p>Hiện tại chưa có ứng viên nào ứng tuyển vào vị trí này.</p>
        </div>
        <div th:if="${applications != null and !applications.isEmpty()}">
            <table>
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên ứng viên</th>
                    <th>Email & Phone</th>
                    <th>Ngày ứng tuyển</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
                <th:block th:each="jobApplication, iterStat : ${applications}">
                    <tr style="margin-bottom: 18px; display: table-row;">
                        <td th:text="${iterStat.count}"></td>
                        <td>
                            <div class="candidate-name">
                                <strong th:text="${jobApplication.fullName}"></strong>
                            </div>
                        </td>
                        <td>
                            <div class="candidate-contact">
                                <small class="text-muted" th:text="${jobApplication.email}"></small>
                                <br>
                                <small class="text-muted" th:if="${jobApplication.phone}" th:text="${jobApplication.phone}"></small>
                            </div>
                        </td>
                        <td>
                            <span th:text="${#temporals.format(jobApplication.appliedAt, 'dd/MM/yyyy HH:mm')}"></span>
                        </td>
                        <td>
                            <span class="status-badge"
                                  th:classappend="${jobApplication.status.toString().toLowerCase()}"
                                  th:text="${jobApplication.status}"></span>
                        </td>
                        <td>
                            <div class="cell action-col" style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                <button class="btn-view-details" th:onclick="'toggleDetails(' + ${iterStat.index} + ')'" th:id="'btn-details-' + ${iterStat.index}">
                                    <i class="bi bi-chevron-down"></i>
                                    <span>Xem chi tiết</span>
                                </button>
                                <div class="dropdown dropend" style="position: relative; margin-left: 8px;">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                            type="button"
                                            th:id="'dropdownMenuButton' + ${jobApplication.applicationId}"
                                            data-bs-toggle="dropdown"
                                            data-bs-auto-close="true"
                                            data-bs-container="body"
                                            data-bs-display="static"
                                            aria-expanded="false">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                    <ul class="dropdown-menu" th:aria-labelledby="'dropdownMenuButton' + ${jobApplication.applicationId}">
                                        <li th:each="statusOption : ${statuses}">
                                            <form th:action="@{/Employer/Applications/{id}/updateStatus(id=${jobApplication.applicationId})}" method="post" class="d-inline status-form w-100">
                                                <input type="hidden" name="jobPostId" th:value="${jobPost.jobPostId}" />
                                                <input type="hidden" name="status" th:value="${statusOption.name()}" />
                                                <button type="submit" class="dropdown-item w-100"
                                                        th:text="${statusOption.name()}"
                                                        th:disabled="${jobApplication.status.name() == statusOption.name()}"
                                                        th:attr="data-application-id=${jobApplication.applicationId},data-status=${statusOption.name()}"
                                                        onclick="return handleStatusClick(event, this)"
                                                        style="text-align: left; border: none; background: none;">
                                                    <span th:text="${statusOption.name()}"></span>
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- Details row hiện ngay dưới mỗi row -->
                    <tr class="details-row" th:id="'details-' + ${iterStat.index}" style="display: none;">
                        <td colspan="6" style="padding: 0;">
                            <div class="details-content">
                                <!-- Hiện CV nếu có -->
                                <div th:if="${jobApplication.cvUrl != null and !#strings.isEmpty(jobApplication.cvUrl)}" style="text-align: center; margin: 0 auto; max-width: 800px;">
                                    <h4 style="text-align: center; margin-bottom: 20px; color: #374151;"><i class="bi bi-file-earmark-text"></i> CV của ứng viên</h4>
                                    <img th:if="${#strings.endsWith(jobApplication.cvUrl, '.jpg') or #strings.endsWith(jobApplication.cvUrl, '.jpeg') or #strings.endsWith(jobApplication.cvUrl, '.png') or #strings.endsWith(jobApplication.cvUrl, '.gif')}"
                                         th:src="${jobApplication.cvUrl}" alt="CV Image" style="max-width:100%; max-height:800px; display:block; margin:0 auto; border-radius: 8px; box-shadow: 0 4px 16px rgba(80,37,196,0.12);"/>
                                    <iframe th:if="${!(#strings.endsWith(jobApplication.cvUrl, '.jpg') or #strings.endsWith(jobApplication.cvUrl, '.jpeg') or #strings.endsWith(jobApplication.cvUrl, '.png') or #strings.endsWith(jobApplication.cvUrl, '.gif'))}"
                                            th:src="'https://docs.google.com/viewer?url=' + ${jobApplication.cvUrl} + '&embedded=true'"
                                            style="width:100%; height:800px; border:none; border-radius: 8px; box-shadow: 0 4px 16px rgba(80,37,196,0.12);">
                                    </iframe>
                                </div>
                            </div>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>
    </div>
    <a th:href="@{/Employer/JobPosts}" class="btn btn-secondary mt-4"><i class="bi bi-arrow-left"></i> Quay lại</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function toggleDetails(index) {
    const detailsRow = document.getElementById('details-' + index);
    const button = document.getElementById('btn-details-' + index);
    const icon = button.querySelector('i');
    const text = button.querySelector('span');
    if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        detailsRow.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
        text.textContent = 'Xem chi tiết';
        button.classList.remove('expanded');
    } else {
        detailsRow.style.display = 'table-row';
        setTimeout(() => {
            detailsRow.classList.add('show');
        }, 10);
        icon.className = 'bi bi-chevron-up';
        text.textContent = 'Ẩn chi tiết';
        button.classList.add('expanded');
        setTimeout(() => {
            detailsRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 200);
    }
}
function handleStatusClick(event, btn) {
    var status = btn.getAttribute('data-status');
    var applicationId = btn.getAttribute('data-application-id');
    if (status === 'INTERVIEW') {
        event.preventDefault();
        // Set action cho form modal
        var form = document.getElementById('interviewForm');
        form.action = '/Employer/Applications/' + applicationId + '/sendInterviewMail';
        // Set jobPostId cho modal
        var jobPostId = btn.form.querySelector('input[name="jobPostId"]').value;
        document.getElementById('modalJobPostId').value = jobPostId;
        // Reset form modal nếu cần
        form.reset();
        // Hiện modal
        var modal = new bootstrap.Modal(document.getElementById('interviewModal'));
        modal.show();
        return false;
    }
    return true;
}
document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            container: 'body',
            placement: 'bottom',
            html: true
        });
    });
});
let statusModal = null;
function openStatusModal(el) {
    const applicationId = el.getAttribute('data-application-id');
    const currentStatus = el.getAttribute('data-current-status');
    const jobPostId = el.getAttribute('data-jobpost-id');
    // Lấy các trạng thái từ Thymeleaf (render sẵn dưới dạng JS array)
    const statuses = /*[[${statuses}]]*/ ["PENDING","APPROVED","REJECTED"];
    // Tạo các nút trạng thái
    let html = '';
    statuses.forEach(function(status) {
        html += `<button type="submit" name="status" value="${status}" class="btn btn-sm ${status === currentStatus ? 'btn-primary' : 'btn-outline-secondary'}" style="min-width: 100px; margin: 4px;" ${status === currentStatus ? 'disabled' : ''}>${status}</button>`;
    });
    document.getElementById('statusOptions').innerHTML = html;
    // Set action cho form
    document.getElementById('statusForm').action = `/Employer/Applications/${applicationId}/updateStatus`;
    document.getElementById('modalJobPostId').value = jobPostId;
    // Hiện modal
    if (!statusModal) statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    statusModal.show();
}
</script>
</body>
</html> 