<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch ·ª®ng Vi√™n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/navbar.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarEnhanced.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarEmployer.css}" />
    <link rel="stylesheet" th:href="@{/css/viewListApplication.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarViewJobPost.css}" />
    <link rel="stylesheet" th:href="@{/css/language_sidebar.css}" />
    <style>
        /* Fix dropdown overflow issues */
        .table-container {
            overflow: visible !important;
        }

        table {
            overflow: visible !important;
        }

        tbody {
            overflow: visible !important;
        }

        tbody tr {
            position: relative;
            overflow: visible !important;
        }

        tbody td {
            overflow: visible !important;
            position: relative;
        }

        .action-buttons {
            position: relative;
            overflow: visible !important;
        }

        .dropdown {
            position: relative !important;
            overflow: visible !important;
        }

        /* Ensure dropdown shows on top - open UPWARD */
        .dropdown-menu {
            position: absolute !important;
            z-index: 99999 !important;
            min-width: 10rem;
            padding: 0.5rem 0;
            margin: 0;
            font-size: 0.875rem;
            color: #212529;
            text-align: left;
            list-style: none;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
            bottom: 100% !important;
            left: 0 !important;
            right: auto !important;
            transform: none !important;
            margin-bottom: 5px !important;
        }

        /* Additional dropdown fixes */
        .dropdown-menu.show {
            position: absolute !important;
            z-index: 99999 !important;
            display: block !important;
        }

        .table-responsive {
            overflow: visible !important;
        }

        /* Force dropdown to stay on top in table - open UPWARD */
        .dropdown.show .dropdown-menu,
        .dropup.show .dropdown-menu {
            position: absolute !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            bottom: 100% !important;
            left: 0 !important;
            right: auto !important;
            margin-bottom: 5px !important;
        }

        /* Ensure table cells don't clip dropdown */
        tbody td:last-child {
            overflow: visible !important;
            position: relative;
            min-width: 250px !important;
        }

        /* Action column styling */
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            min-width: 220px;
        }

        /* Prevent table layout from constraining cells */
        table {
            table-layout: auto !important;
        }

        .dropdown-item {
            display: block !important;
            width: 100% !important;
            padding: 0.375rem 1rem !important;
            clear: both;
            font-weight: 400;
            color: #212529 !important;
            text-align: inherit;
            text-decoration: none;
            white-space: nowrap;
            background-color: transparent;
            border: 0;
        }

        .dropdown-item:hover {
            background-color: #e9ecef !important;
        }

        .dropdown-item:disabled {
            color: #6c757d !important;
            background-color: transparent !important;
        }

        /* Force visibility of dropdown toggle */
        .dropdown-toggle {
            background: transparent !important;
            border: 1px solid #dee2e6 !important;
            color: #6c757d !important;
        }

        /* Active state when dropdown is open */
        .dropdown.show .dropdown-toggle,
        .dropup.show .dropdown-toggle {
            background: #f8f9fa !important;
            border-color: #007bff !important;
            color: #007bff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        }

        /* Hover state */
        .dropdown-toggle:hover {
            background: #f8f9fa !important;
            border-color: #adb5bd !important;
            color: #495057 !important;
        }

        /* Icon color changes */
        .dropdown-toggle i {
            color: inherit !important;
        }

        /* Focus state */
        .dropdown-toggle:focus {
            background: #f8f9fa !important;
            border-color: #007bff !important;
            color: #007bff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        }

        .dropdown-toggle::after {
            display: inline-block;
            margin-left: 0.255em;
            vertical-align: 0.255em;
            content: "";
            border-top: 0.3em solid;
            border-right: 0.3em solid transparent;
            border-bottom: 0;
            border-left: 0.3em solid transparent;
        }

        /* Arrow for dropup - points up */
        .dropup .dropdown-toggle::after {
            border-bottom: 0.3em solid;
            border-top: 0;
            border-left: 0.3em solid transparent;
            border-right: 0.3em solid transparent;
        }

        /* N√∫t CV nh·ªè g·ªçn */
        .btn-cv {
            background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%);
            color: #fff !important;
            border: 2px solid #7c3aed;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 4px 8px;
            box-shadow: 0 2px 8px rgba(80, 37, 196, 0.12);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-cv:hover, .btn-cv:focus {
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            color: #fff;
            box-shadow: 0 4px 16px rgba(80, 37, 196, 0.18);
            border-color: #a78bfa;
        }
        .btn-cv i {
            font-size: 0.8em;
            color: #fff !important;
        }

        /* N√∫t Chat xanh l√° */
        .btn-chat {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white !important;
            border: 2px solid #25d366;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-chat:hover {
            background: linear-gradient(135deg, #128c7e 0%, #075e54 100%);
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            border-color: #128c7e;
        }
        .btn-chat i {
            font-size: 0.8em;
            color: white !important;
        }

        .cell.action-col { min-width: 220px; }
        .status-badge { font-size: 1rem; font-weight: 600; padding: 6px 18px; border-radius: 16px; }
        .btn-view-details { min-width: 120px; }
        .dropdown.dropend { margin-left: 0; }
        tbody tr { margin-bottom: 18px !important; }

        /* Off-canvas Chat Styles */
        .chat-offcanvas {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 10000;
            display: flex;
            flex-direction: column;
        }

        .chat-offcanvas.show {
            right: 0;
        }

        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .chat-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Chat Header */
        .chat-header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .chat-header .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
        }

        .chat-header .info h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-header .info p {
            margin: 0;
            opacity: 0.8;
            font-size: 14px;
        }

        .chat-header .close-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .chat-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .message.received .message-bubble {
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 10px 20px;
            background: #f1f5f9;
            border-top: 1px solid #e2e8f0;
            font-size: 14px;
            color: #64748b;
            display: none;
        }

        .typing-dots {
            display: inline-flex;
            margin-left: 5px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #64748b;
            margin: 0 1px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Chat Input */
        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .chat-input input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .chat-input button {
            width: 45px;
            height: 45px;
            border: none;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .chat-input button:hover {
            transform: scale(1.05);
        }
        /* Status badges with colors */
        .status-badge {
            padding: 8px 16px !important;
            border-radius: 20px !important;
            font-size: 0.85rem !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            display: inline-block !important;
        }

        .status-badge.submitted {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
            color: white !important;
        }

        .status-badge.interview {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: white !important;
        }

        .status-badge.accepted {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white !important;
        }

        .status-badge.rejected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
        }

        /* Larger buttons */
        .btn-cv, .btn-chat {
            padding: 10px 16px !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
        }

        .btn-cv {
            background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%) !important;
            color: #fff !important;
            border: 2px solid #7c3aed !important;
        }

        .btn-cv:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.3) !important;
        }

        .btn-chat {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%) !important;
            color: #fff !important;
            border: 2px solid #10b981 !important;
        }

        .btn-chat:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3) !important;
        }

        /* Dropdown button larger */
        .dropdown-toggle {
            padding: 10px 12px !important;
            font-size: 0.9rem !important;
        }

        /* Fix table overflow and responsive */
        .table-container {
            overflow-x: auto !important;
            max-width: 100% !important;
            margin: 0 auto !important;
        }

        table {
            min-width: 100% !important;
            width: 100% !important;
            table-layout: fixed !important;
        }

        /* Column widths */
        table th:nth-child(1) { width: 8% !important; } /* STT */
        table th:nth-child(2) { width: 15% !important; } /* T√™n */
        table th:nth-child(3) { width: 20% !important; } /* Email & Phone */
        table th:nth-child(4) { width: 15% !important; } /* Ng√†y */
        table th:nth-child(5) { width: 12% !important; } /* Tr·∫°ng th√°i */
        table th:nth-child(6) { width: 30% !important; } /* H√†nh ƒë·ªông */

        table td:nth-child(1) { width: 8% !important; }
        table td:nth-child(2) { width: 15% !important; }
        table td:nth-child(3) { width: 20% !important; }
        table td:nth-child(4) { width: 15% !important; }
        table td:nth-child(5) { width: 12% !important; }
        table td:nth-child(6) { width: 30% !important; }

        /* Text overflow handling */
        .candidate-name strong {
            display: block !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 100% !important;
        }

        .candidate-contact small {
            display: block !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 100% !important;
        }

        /* Action buttons responsive */
        .action-buttons {
            display: flex !important;
            gap: 6px !important;
            align-items: center !important;
            flex-wrap: wrap !important;
            justify-content: center !important;
        }

        .btn-cv, .btn-chat {
            flex: 0 0 auto !important;
            min-width: 60px !important;
        }

        /* Mobile responsive */
        @media (max-width: 1200px) {
            .action-buttons {
                gap: 4px !important;
            }

            .btn-cv, .btn-chat {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
            }

            .btn-cv span, .btn-chat span {
                display: none !important;
            }
        }
    </style>
</head>
<body>
<div th:replace="~{navbar/navbarEmployee :: navbarEmployee}"></div>

<!-- Modal G·ª≠i L·ªãch Ph·ªèng V·∫•n -->
<div class="modal fade" id="interviewModal" tabindex="-1" aria-labelledby="interviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="interviewForm" method="post">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="interviewModalLabel">G·ª≠i l·ªãch ph·ªèng v·∫•n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="jobPostId" id="modalJobPostId" />
          <div class="mb-3">
            <label>Th·ªùi gian ph·ªèng v·∫•n</label>
            <input type="datetime-local" name="interviewTime" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>H√¨nh th·ª©c</label>
            <select name="interviewType" class="form-control">
              <option value="Online">Online</option>
              <option value="Offline">Offline</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Link meeting (n·∫øu c√≥)</label>
            <input type="text" name="meetingLink" class="form-control">
          </div>
          <div class="mb-3">
            <label>Ghi ch√∫</label>
            <textarea name="note" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="submit" class="btn btn-primary">G·ª≠i l·ªãch ph·ªèng v·∫•n</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal ƒë·ªïi tr·∫°ng th√°i -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="statusForm" method="post">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="statusModalLabel">ƒê·ªïi tr·∫°ng th√°i ·ª©ng vi√™n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="statusOptions" class="d-flex flex-wrap gap-2"></div>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="main-content">
    <h1 th:text="'·ª®ng vi√™n cho c√¥ng vi·ªác: ' + ${jobPost.jobTitle}"></h1>

    <!-- Statistics cards -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="stat-info">
                <h3 th:text="${totalApplications ?: 0}">0</h3>
                <p>T·ªïng s·ªë ·ª©ng vi√™n</p>
            </div>
        </div>
    </div>

    <!-- Table container -->
    <div class="table-container">
        <div th:if="${applications == null or applications.isEmpty()}" class="empty-state">
            <i class="bi bi-person-x"></i>
            <h3>Ch∆∞a c√≥ ·ª©ng vi√™n n√†o</h3>
            <p>Hi·ªán t·∫°i ch∆∞a c√≥ ·ª©ng vi√™n n√†o ·ª©ng tuy·ªÉn v√†o v·ªã tr√≠ n√†y.</p>
        </div>
        <div th:if="${applications != null and !applications.isEmpty()}">
            <table>
                <thead>
                <tr>
                    <th>STT</th>
                    <th>T√™n ·ª©ng vi√™n</th>
                    <th>Email & Phone</th>
                    <th>Ng√†y ·ª©ng tuy·ªÉn</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody>
                <th:block th:each="jobApplication, iterStat : ${applications}">
                    <tr style="margin-bottom: 18px; display: table-row;">
                        <td th:text="${iterStat.count}"></td>
                        <td>
                            <div class="candidate-name">
                                <strong th:text="${jobApplication.fullName}"></strong>
                            </div>
                        </td>
                        <td>
                            <div class="candidate-contact">
                                <small class="text-muted" th:text="${jobApplication.email}"></small>
                                <br>
                                <small class="text-muted" th:if="${jobApplication.phone}" th:text="${jobApplication.phone}"></small>
                            </div>
                        </td>
                        <td>
                            <span th:text="${#temporals.format(jobApplication.appliedAt, 'dd/MM/yyyy HH:mm')}"></span>
                        </td>
                        <td>
                            <span class="status-badge"
                                  th:classappend="${jobApplication.status.toString().toLowerCase()}"
                                  th:text="${jobApplication.status}"></span>
                        </td>
                        <td>
                            <div class="cell action-col" style="display: flex; align-items: center; gap: 4px;">
                                <button class="btn-cv" th:onclick="'toggleDetails(' + ${iterStat.index} + ')'" th:id="'btn-details-' + ${iterStat.index}">
                                    <i class="bi bi-chevron-down"></i>
                                    <span>CV</span>
                                </button>
                                <button class="btn-chat" title="Nh·∫Øn tin v·ªõi ·ª©ng vi√™n"
                                        th:attr="data-user-name=${jobApplication.fullName},data-user-email=${jobApplication.email}"
                                        onclick="openChatFromButton(this)">
                                    <i class="bi bi-chat-dots"></i>
                                    <span>Chat</span>
                                </button>
                                <div class="dropdown dropup" style="position: relative;">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                            type="button"
                                            th:id="'dropdownMenuButton' + ${jobApplication.applicationId}"
                                            data-bs-toggle="dropdown"
                                            data-bs-auto-close="true"
                                            aria-expanded="false">
                                        <i class="bi bi-gear"></i>
                                    </button>

                                    <ul class="dropdown-menu" th:aria-labelledby="'dropdownMenuButton' + ${jobApplication.applicationId}">
                                        <li th:each="statusOption : ${statuses}">
                                            <form th:action="@{/Employer/JobPosts/{jobPostId}/applications/{applicationId}/updateStatus(jobPostId=${jobPost.jobPostId},applicationId=${jobApplication.applicationId})}"
                                                  method="post" class="d-inline status-form w-100">
                                                <input type="hidden" name="status" th:value="${statusOption.name()}">
                                                <button type="submit" class="dropdown-item w-100"
                                                        th:text="${statusOption.name()}"
                                                        th:disabled="${jobApplication.status.name() == statusOption.name()}"
                                                        th:attr="data-application-id=${jobApplication.applicationId},data-status=${statusOption.name()}"
                                                        onclick="return handleStatusClick(event, this)"
                                                        style="text-align: left; border: none; background: none;">
                                                    <span th:text="${statusOption.name()}"></span>
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- Details row hi·ªán ngay d∆∞·ªõi m·ªói row -->
                    <tr class="details-row" th:id="'details-' + ${iterStat.index}" style="display: none;">
                        <td colspan="6" style="padding: 0;">
                            <div class="details-content">
                                <!-- Hi·ªán CV n·∫øu c√≥ -->
                                <div th:if="${jobApplication.cvUrl != null and !#strings.isEmpty(jobApplication.cvUrl)}" style="text-align: center; margin: 0 auto; max-width: 800px;">
                                    <h4 style="text-align: center; margin-bottom: 20px; color: #374151;"><i class="bi bi-file-earmark-text"></i> CV c·ªßa ·ª©ng vi√™n</h4>
                                    <img th:if="${#strings.endsWith(jobApplication.cvUrl, '.jpg') or #strings.endsWith(jobApplication.cvUrl, '.jpeg') or #strings.endsWith(jobApplication.cvUrl, '.png') or #strings.endsWith(jobApplication.cvUrl, '.gif')}"
                                         th:src="${jobApplication.cvUrl}" alt="CV Image" style="max-width:100%; max-height:800px; display:block; margin:0 auto; border-radius: 8px; box-shadow: 0 4px 16px rgba(80,37,196,0.12);"/>
                                    <iframe th:if="${!(#strings.endsWith(jobApplication.cvUrl, '.jpg') or #strings.endsWith(jobApplication.cvUrl, '.jpeg') or #strings.endsWith(jobApplication.cvUrl, '.png') or #strings.endsWith(jobApplication.cvUrl, '.gif'))}"
                                            th:src="'https://docs.google.com/viewer?url=' + ${jobApplication.cvUrl} + '&embedded=true'"
                                            style="width:100%; height:800px; border:none; border-radius: 8px; box-shadow: 0 4px 16px rgba(80,37,196,0.12);">
                                    </iframe>
                                </div>
                            </div>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Back button -->
    <div style="text-align: center; margin-top: 30px;">
        <a th:href="@{/Employer/JobPosts}" class="btn btn-secondary" style="padding: 12px 30px; border-radius: 8px;">
            <i class="bi bi-arrow-left"></i> QUAY L·∫†I
        </a>
    </div>

    <!-- Floating action button -->
    <a th:href="@{/Employer/JobPosts}" class="fab">
        <i class="bi bi-arrow-left"></i>
    </a>
</div>

<!-- Chat Off-canvas -->
<div class="chat-overlay" id="chatOverlay" onclick="closeChat()"></div>
<div class="chat-offcanvas" id="chatOffcanvas">
    <div class="chat-header">
        <button class="back-btn" id="chatBackBtn" onclick="loadAllChatRooms()" style="display: none; background: none; border: none; color: #007bff; font-size: 18px; margin-right: 10px; cursor: pointer;">
            <i class="bi bi-arrow-left"></i>
        </button>
        <div class="avatar" id="chatAvatar">VT</div>
        <div class="info">
            <h4 id="chatName">Vi·ªát T√†i</h4>
            <p id="chatStatus">ƒêang ho·∫°t ƒë·ªông</p>
        </div>
        <button class="close-btn" onclick="closeChat()">
            <i class="bi bi-x"></i>
        </button>
    </div>

    <div class="chat-messages" id="chatMessages">
        <!-- Sample messages -->
        <div class="message received">
            <div class="message-bubble">
                Xin ch√†o! T√¥i ƒë√£ n·ªôp h·ªì s∆° ·ª©ng tuy·ªÉn v·ªã tr√≠ IT t·∫°i c√¥ng ty.
                <div class="message-time">08:25</div>
            </div>
        </div>
        <div class="message sent">
            <div class="message-bubble">
                C·∫£m ∆°n b·∫°n ƒë√£ ·ª©ng tuy·ªÉn! Ch√∫ng t√¥i s·∫Ω xem x√©t h·ªì s∆° v√† ph·∫£n h·ªìi s·ªõm nh·∫•t.
                <div class="message-time">08:26</div>
            </div>
        </div>
        <div class="message received">
            <div class="message-bubble">
                V√¢ng ·∫°, c·∫£m ∆°n anh/ch·ªã. Em mong ƒë∆∞·ª£c l√†m vi·ªác c√πng c√¥ng ty.
                <div class="message-time">08:27</div>
            </div>
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <span id="typingUser">Vi·ªát T√†i</span> ƒëang so·∫°n tin nh·∫Øn
        <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="chat-input">
        <form class="chat-input-form" onsubmit="sendMessage(event)">
            <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
            <button type="submit">
                <i class="bi bi-send"></i>
            </button>
        </form>
    </div>
</div>

<!-- WebSocket Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!-- Chat System Scripts -->
<script th:src="@{/js/chat-websocket.js}"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/language-dropdown.js}"></script>
<script>
function toggleDetails(index) {
    const detailsRow = document.getElementById('details-' + index);
    const button = document.getElementById('btn-details-' + index);
    const icon = button.querySelector('i');
    const text = button.querySelector('span');

    if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        detailsRow.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
        text.textContent = 'CV';
        button.classList.remove('expanded');
    } else {
        detailsRow.style.display = 'table-row';
        setTimeout(() => {
            detailsRow.classList.add('show');
        }, 10);
        icon.className = 'bi bi-chevron-up';
        text.textContent = 'CV';
        button.classList.add('expanded');

        // Scroll to the details row
        setTimeout(() => {
            detailsRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 200);
    }
}
function handleStatusClick(event, btn) {
    var status = btn.getAttribute('data-status');
    var applicationId = btn.getAttribute('data-application-id');
    if (status === 'INTERVIEW') {
        event.preventDefault();
        // Get jobPostId from current URL path
        var pathParts = window.location.pathname.split('/');
        var jobPostId = pathParts[3]; // /Employer/JobPosts/{jobPostId}/applications

        // Set action cho form modal
        var form = document.getElementById('interviewForm');
        form.action = '/Employer/JobPosts/' + jobPostId + '/applications/' + applicationId + '/sendInterviewMail';

        // Set jobPostId cho modal n·∫øu c√≥ hidden input
        var modalJobPostIdInput = document.getElementById('modalJobPostId');
        if (modalJobPostIdInput) {
            modalJobPostIdInput.value = jobPostId;
        }

        // Reset form modal n·∫øu c·∫ßn
        form.reset();
        // Hi·ªán modal
        var modal = new bootstrap.Modal(document.getElementById('interviewModal'));
        modal.show();
        return false;
    }
    return true;
}

// Chat WebSocket Client
let chatWebSocketClient = null;
let currentChatRoomId = null;
let currentUserId = null;
let currentUserName = null;

// Initialize WebSocket when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get current user info using correct endpoint
    fetch('/api/chat/current-user')
        .then(response => response.json())
        .then(userInfo => {
            currentUserId = userInfo.userId;
            currentUserName = userInfo.fullName;
            initializeWebSocket();
            console.log('‚úÖ User info loaded:', userInfo);
        })
        .catch(error => {
            console.log('Could not load user info, using fallback');
            // Fallback - you can set default values or get from session
            currentUserId = 1; // Default employer ID
            currentUserName = "Employer";
            initializeWebSocket();
        });
});

function initializeWebSocket() {
    if (window.ChatWebSocketClient) {
        chatWebSocketClient = new ChatWebSocketClient();

        // Set callbacks with debug
        chatWebSocketClient.onMessageReceived = (message) => {
            console.log('üîÑ WebSocket callback triggered with message:', message);
            handleNewMessage(message);
        };
        chatWebSocketClient.onConnected = () => console.log('‚úÖ Chat WebSocket connected');
        chatWebSocketClient.onError = (error) => console.error('‚ùå Chat error:', error);

        // Connect to WebSocket
        chatWebSocketClient.connect(currentUserId, currentUserName);
    }
}

// Handle new message received from WebSocket
function handleNewMessage(message) {
    console.log('üí¨ Handling new message:', message);

    // Only add message to UI if it's from someone else
    if (message.senderId !== currentUserId) {
        addMessageToUI(message);
    }
}

/**
 * üéØ Chat tr·ª±c ti·∫øp v·ªõi student c·ª• th·ªÉ
 * ƒê∆∞·ª£c g·ªçi khi b·∫•m n√∫t "Chat" b√™n c·∫°nh t√™n ·ª©ng vi√™n
 */
function openChatFromButton(button) {
    const userName = button.getAttribute('data-user-name');
    const userEmail = button.getAttribute('data-user-email');

    console.log('üéØ Opening direct chat with student:', userName, userEmail);

    if (!userName || !userEmail) {
        console.error('‚ùå Missing user data on button');
        alert('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ·ª©ng vi√™n. Vui l√≤ng th·ª≠ l·∫°i.');
        return;
    }

    // Chat tr·ª±c ti·∫øp v·ªõi student n√†y
    openDirectChatWithStudent(userName, userEmail);
}

// Function to open direct chat with a specific student
function openDirectChatWithStudent(userName, userEmail) {
    console.log('üöÄ Opening direct chat with:', userName, userEmail);

    // Update chat header info
    document.getElementById('chatName').textContent = userName;
    document.getElementById('chatAvatar').textContent = userName.charAt(0).toUpperCase();
    document.getElementById('chatStatus').textContent = 'ƒêang ho·∫°t ƒë·ªông';

    // Show chat off-canvas
    document.getElementById('chatOverlay').classList.add('show');
    document.getElementById('chatOffcanvas').classList.add('show');

    // Hide back button since we're going directly to chat
    const backBtn = document.getElementById('chatBackBtn');
    if (backBtn) {
        backBtn.style.display = 'none';
    }

    // Try to find or create chat room with this student
    tryCreateChatRoomWithStudent(userName, userEmail);
}

async function tryCreateChatRoomWithStudent(userName, userEmail) {
    try {
        console.log('üîç Finding student by email:', userEmail);

        // First, try to find existing chat rooms
        const roomsResponse = await fetch('/api/chat/rooms');
        if (roomsResponse.ok) {
            const rooms = await roomsResponse.json();
            console.log('üìã Existing rooms:', rooms);

            // Try to find a room for this student
            const existingRoom = rooms.find(room =>
                room.otherParticipantName &&
                (room.otherParticipantName.toLowerCase().includes(userName.toLowerCase()) ||
                 room.otherParticipantName.includes(userEmail.split('@')[0]))
            );

            if (existingRoom) {
                console.log('‚úÖ Found existing room:', existingRoom);
                currentChatRoomId = String(existingRoom.chatRoomId);

                // Join WebSocket room
                if (chatWebSocketClient && chatWebSocketClient.isConnected) {
                    chatWebSocketClient.joinRoom(Number(currentChatRoomId));
                }

                // Load chat history
                loadChatHistory(currentChatRoomId);
                return;
            }
        }

        // If no existing room found, try to CREATE REAL chat room
        console.log('üèóÔ∏è No existing room found, creating REAL chat room for:', userName, userEmail);
        await createRealChatRoomWithStudent(userName, userEmail);

    } catch (error) {
        console.error('Error finding/creating chat room:', error);
        // Fallback to demo mode if API fails
        createNewChatSession(userName, userEmail);
    }
}

// CREATE REAL chat room via API
async function createRealChatRoomWithStudent(userName, userEmail) {
    try {
        console.log('üèóÔ∏è Creating REAL chat room via API for:', userName, userEmail);

        // Try to find student ID by email first
        const studentResponse = await fetch(`/api/students/findByEmail?email=${encodeURIComponent(userEmail)}`);

        let studentUserId = null;
        if (studentResponse.ok) {
            const studentData = await studentResponse.json();
            studentUserId = studentData.userId; // Use Account.userId, not Student.studentId
            console.log('üë§ Found student data:', studentData);
            console.log('üë§ Using student userId:', studentUserId);
        }

        // If we can't find student userId, use current user ID as fallback
        if (!studentUserId) {
            console.warn('‚ö†Ô∏è Could not find student userId, creating demo session');
            createNewChatSession(userName, userEmail);
            return;
        }

        // Create real chat room via API
        const createRoomResponse = await fetch('/api/chat/rooms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                studentId: studentUserId,    // Student's Account.userId
                employerId: currentUserId,   // Employer's Account.userId
                jobPostId: null             // General chat, not job-specific
            })
        });

        if (createRoomResponse.ok) {
            const newRoom = await createRoomResponse.json();
            console.log('‚úÖ Successfully created real chat room:', newRoom);

            currentChatRoomId = String(newRoom.chatRoomId);

            // Join WebSocket room
            if (chatWebSocketClient && chatWebSocketClient.isConnected) {
                chatWebSocketClient.joinRoom(Number(currentChatRoomId));
            }

            // Show ready chat interface
            showReadyChatInterface(userName);

        } else {
            console.error('‚ùå Failed to create chat room via API');
            // Fallback to demo mode
            createNewChatSession(userName, userEmail);
        }

    } catch (error) {
        console.error('Error creating real chat room:', error);
        // Fallback to demo mode
        createNewChatSession(userName, userEmail);
    }
}

// Function to show ready chat interface after room creation
function showReadyChatInterface(userName) {
    // LOAD CHAT HISTORY FIRST before showing UI
    console.log('üìú Loading chat history for room:', currentChatRoomId);
    loadChatHistory(currentChatRoomId);

    // Enable input for sending messages
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.placeholder = `Nh·∫≠p tin nh·∫Øn cho ${userName}...`;
        messageInput.disabled = false;
        messageInput.focus();
    }

    // Update chat title and status
    document.getElementById('chatName').textContent = `üí¨ ${userName}`;
    document.getElementById('chatStatus').textContent = 'ƒêang ho·∫°t ƒë·ªông';
    document.getElementById('chatOverlay').classList.add('show');
    document.getElementById('chatOffcanvas').classList.add('show');

    console.log('‚úÖ Chat ready with history for:', userName);
}

// Function to create new chat session when no existing room found
function createNewChatSession(userName, userEmail) {
    console.log('üìù Creating new chat session for:', userName, userEmail);

    // Show chat interface ready for messaging
    const messagesContainer = document.getElementById('chatMessages');

    messagesContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #666;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h5 style="margin: 0 0 10px 0;">üí¨ Chat v·ªõi ${userName}</h5>
                <p style="margin: 0; font-size: 14px; opacity: 0.9;">
                    B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán ngay b√¢y gi·ªù!
                </p>
            </div>
            <div style="color: #999; font-size: 12px;">
                üí° Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c g·ª≠i real-time
            </div>
        </div>
    `;

    // Enable input for sending messages
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.placeholder = `Nh·∫≠p tin nh·∫Øn cho ${userName}...`;
        messageInput.disabled = false;
        messageInput.focus(); // Auto focus v√†o input
    }

    // Set a temporary room ID for this conversation
    currentChatRoomId = 'new_' + userEmail.replace('@', '_').replace('.', '_');
    console.log('üìù Created new chat session with ID:', currentChatRoomId);
}

function loadChatHistory(roomId) {
    // Use correct endpoint format
    fetch(`/api/chat/rooms/${roomId}/messages?page=0&size=50`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load messages');
            }
            return response.json();
        })
        .then(messages => {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = ''; // Clear existing messages

            // Handle both array and paginated response
            const messageList = Array.isArray(messages) ? messages : (messages.content || []);

            messageList.forEach(message => {
                addMessageToUI(message);
            });

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
            // Show default messages or empty state
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #666;">
                    <p>Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ chat</p>
                    <p><small>B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán b·∫±ng c√°ch g·ª≠i tin nh·∫Øn ƒë·∫ßu ti√™n</small></p>
                </div>
            `;
        });
}

function closeChat() {
    // Leave WebSocket room
    if (chatWebSocketClient && currentChatRoomId) {
        chatWebSocketClient.leaveRoom();
        currentChatRoomId = null;
    }

    document.getElementById('chatOverlay').classList.remove('show');
    document.getElementById('chatOffcanvas').classList.remove('show');
}

function addMessageToUI(message) {
    const messagesContainer = document.getElementById('chatMessages');

    // Generate unique ID for duplicate detection
    const messageId = message.id || `local_${message.content}_${message.senderId}_${message.sentAt}`;

    // Check for duplicate messages
    if (document.querySelector(`[data-message-id="${messageId}"]`)) {
        console.log('üîÑ Duplicate message detected, skipping:', message.content);
        return;
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.senderId === currentUserId ? 'sent' : 'received'}`;
    messageDiv.setAttribute('data-message-id', messageId);

    // Safe timestamp parsing - use sentAt field from backend
    let time = 'B√¢y gi·ªù';
    try {
        if (message.sentAt) {
            const date = new Date(message.sentAt);
            if (!isNaN(date.getTime())) {
                time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        } else if (message.timestamp) {
            // Fallback for manually created messages
            const date = new Date(message.timestamp);
            if (!isNaN(date.getTime())) {
                time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }
    } catch (error) {
        console.warn('Invalid timestamp:', message.sentAt || message.timestamp);
        time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${message.content}
            <div class="message-time">${time}</div>
        </div>
    `;

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    console.log('üí¨ Added message to UI:', message.content, 'ID:', messageId);
}

function sendMessage(event) {
    event.preventDefault();

    const input = document.getElementById('messageInput');
    const content = input.value.trim();

    if (!content || !currentChatRoomId) return;

    // Prevent double sending
    if (input.dataset.sending === 'true') {
        console.log('‚ö†Ô∏è Message already being sent, ignoring duplicate');
        return;
    }

    // Mark as sending
    input.dataset.sending = 'true';
    input.disabled = true;

    // Send via WebSocket if available
    if (chatWebSocketClient && chatWebSocketClient.isConnected) {
        const success = chatWebSocketClient.sendMessage(content);

        if (success) {
            // Add message to UI immediately for better UX
            const message = {
                content: content,
                senderId: currentUserId,
                sentAt: new Date().toISOString()
            };
            addMessageToUI(message);

            // Clear input
            input.value = '';
        }
    }

    // Reset sending state
    setTimeout(() => {
        input.dataset.sending = 'false';
        input.disabled = false;
        input.focus();
    }, 100);
}

document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            container: 'body',
            placement: 'bottom',
            html: true
        });
    });


});
let statusModal = null;
function openStatusModal(el) {
    const applicationId = el.getAttribute('data-application-id');
    const currentStatus = el.getAttribute('data-current-status');
    const jobPostId = el.getAttribute('data-jobpost-id');
    // L·∫•y c√°c tr·∫°ng th√°i t·ª´ Thymeleaf (render s·∫µn d∆∞·ªõi d·∫°ng JS array)
    const statuses = /*[[${statuses}]]*/ ["PENDING","APPROVED","REJECTED"];
    // T·∫°o c√°c n√∫t tr·∫°ng th√°i
    let html = '';
    statuses.forEach(function(status) {
        html += `<button type="submit" name="status" value="${status}" class="btn btn-sm ${status === currentStatus ? 'btn-primary' : 'btn-outline-secondary'}" style="min-width: 100px; margin: 4px;" ${status === currentStatus ? 'disabled' : ''}>${status}</button>`;
    });
    document.getElementById('statusOptions').innerHTML = html;
    // Set action cho form
    document.getElementById('statusForm').action = `/Employer/Applications/${applicationId}/updateStatus`;
    document.getElementById('modalJobPostId').value = jobPostId;
    // Hi·ªán modal
    if (!statusModal) statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    statusModal.show();
}
</script>
</body>