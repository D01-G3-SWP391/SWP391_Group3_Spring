<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{employer.candidates.detail.title}">Chi tiết ứng viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/language-switcher.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarHome.css}"/>
    <link rel="stylesheet" th:href="@{/css/navbar.css}"/>
    <link rel="stylesheet" th:href="@{/css/navbarEnhanced.css}"/>
    <link rel="stylesheet" th:href="@{/css/candidateDetail.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarEmployer.css}" />
    <link rel="stylesheet" th:href="@{/css/language_sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/jobInvitation.css}" />
</head>
<body>
<div th:replace="~{navbar/navbarEmployee :: navbarEmployee}"></div>
<div class="container">
    <!-- Header row (title + back button) matching viewListApplications -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 th:text="#{employer.candidates.detail.title}">Chi Tiết Ứng Viên</h1>
        <a th:href="@{/Employer/SearchCandidate}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> <span th:text="#{employer.action.back}">Back to List</span>
        </a>
    </div>

    <!-- Profile Card -->
    <div class="card">
        <div class="row g-0">
            <div class="col-md-4">
                <div class="profile-card text-center">
                    <div class="avatar-circle">
                        <span th:if="${student.account.avatarUrl == null}" th:text="${student.account.fullName.substring(0,1)}">N</span>
                        <img th:if="${student.account.avatarUrl != null}" th:src="${student.account.avatarUrl}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/>
                    </div>
                    <div class="profile-name" th:text="${student.account.fullName}">Nguyen Van An</div>
                    <div class="text-center">
                        <span class="status-badge status-active" th:if="${student.account.status.name() == 'active'}">ACTIVE</span>
                        <span class="status-badge status-inactive" th:if="${student.account.status.name() != 'active'}">INACTIVE</span>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="section-header">
                    <i class="bi bi-person-lines-fill"></i>
                    <span th:text="#{employer.candidates.detail.personal.info}">Personal Information</span>
                </div>
                <div class="section-content">
                    <div class="info-row">
                        <i class="bi bi-person info-icon"></i>
                        <span class="info-label" th:text="#{employer.candidates.detail.full.name}">Full Name</span>
                        <span class="info-value" th:text="${student.account.fullName}"></span>
                    </div>
                    <div class="info-row">
                        <i class="bi bi-envelope info-icon"></i>
                        <span class="info-label" th:text="#{employer.candidates.detail.email}">Email</span>
                        <span class="info-value" th:text="${student.account.email}"></span>
                    </div>
                    <div class="info-row">
                        <i class="bi bi-telephone info-icon"></i>
                        <span class="info-label" th:text="#{employer.candidates.detail.phone}">Phone</span>
                        <span class="info-value" th:text="${student.account.phone}"></span>
                    </div>
                    <div class="info-row">
                        <i class="bi bi-geo-alt info-icon"></i>
                        <span class="info-label" th:text="#{employer.candidates.detail.address}">Address</span>
                        <span class="info-value" th:text="${student.address}"></span>
                    </div>
                    <div class="info-row">
                        <i class="bi bi-shield-check info-icon"></i>
                        <span class="info-label" th:text="#{employer.candidates.detail.role}">Role</span>
                        <span class="badge-custom badge-student" th:text="${student.account.role.name().toUpperCase()}">STUDENT</span>
                    </div>
                    <div class="info-row">
                        <i class="bi bi-check-circle info-icon"></i>
                        <span class="info-label" th:text="#{employer.candidates.detail.status}">Status</span>
                        <span class="badge-custom" th:text="${student.account.status.name().toUpperCase()}">ACTIVE</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Academic Information & Profile Description -->
    <div class="two-column">
        <div class="card">
            <div class="section-header">
                <i class="bi bi-mortarboard"></i>
                <span th:text="#{employer.candidates.detail.academic.info}">Academic Information</span>
            </div>
            <div class="section-content">
                <div class="info-row">
                    <i class="bi bi-building info-icon"></i>
                    <span class="info-label" th:text="#{employer.candidates.detail.university}">University</span>
                    <span class="info-value" th:text="${student.university}"></span>
                </div>
                <div class="info-row">
                    <i class="bi bi-briefcase info-icon"></i>
                    <span class="info-label" th:text="#{employer.candidates.detail.job.field}">Job Field Interest</span>
                    <span class="info-value" th:text="${student.jobField != null ? student.jobField.jobFieldName : ''}"></span>
                </div>
                <div class="info-row">
                    <i class="bi bi-pin-map info-icon"></i>
                    <span class="info-label" th:text="#{employer.candidates.detail.preferred.location}">Preferred Job Location</span>
                    <span class="info-value" th:text="${student.preferredJobAddress}"></span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-header">
                <i class="bi bi-file-person"></i>
                <span th:text="#{employer.candidates.detail.profile.description}">Profile Description</span>
            </div>
            <div class="section-content">
                <div class="description-text" th:utext="${student.profileDescription}">
                </div>
            </div>
        </div>
    </div>

    <!-- Experience -->
    <div class="card">
        <div class="section-header">
            <i class="bi bi-clock-history"></i>
            <span th:text="#{employer.candidates.detail.experience}">Experience</span>
        </div>
        <div class="section-content">
            <div class="description-text" th:utext="${student.experience}">
            </div>
        </div>
    </div>

    <!-- Contact Actions -->
    <div class="card">
        <div class="section-header">
            <i class="bi bi-envelope-plus"></i>
            <span th:text="#{employer.candidates.detail.contact.actions}">Contact Actions</span>
        </div>
        <div class="section-content">
            <div class="contact-actions">
                <button class="btn btn-primary me-2" onclick="openJobInvitationModal()">
                    <i class="bi bi-briefcase-fill"></i> <span th:text="#{employer.candidates.detail.send.invitation}">Gửi lời mời việc làm</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Job Invitation Modal -->
<div class="modal fade" id="jobInvitationModal" tabindex="-1" aria-labelledby="jobInvitationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobInvitationModalLabel">
                    <i class="bi bi-briefcase-fill"></i> <span th:text="#{employer.candidates.detail.invitation.modal.title}">Gửi lời mời việc làm</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="jobInvitationForm">
                    <div class="mb-3">
                        <label for="candidateInfo" class="form-label">
                            <i class="bi bi-person"></i> <span th:text="#{employer.candidates.detail.invitation.candidate}">Ứng viên</span>
                        </label>
                        <div class="candidate-info-display">
                            <div class="candidate-avatar">
                                <span th:if="${student.account.avatarUrl == null}" th:text="${student.account.fullName.substring(0,1)}">N</span>
                                <img th:if="${student.account.avatarUrl != null}" th:src="${student.account.avatarUrl}" alt="avatar"/>
                            </div>
                            <div class="candidate-details">
                                <h6 th:text="${student.account.fullName}">Candidate Name</h6>
                                <p th:text="${student.account.email}">candidate@email.com</p>
                                <span class="badge bg-secondary" th:text="${student.jobField != null ? student.jobField.jobFieldName : 'N/A'}">Field</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="jobPostSelect" class="form-label">
                            <i class="bi bi-briefcase"></i> <span th:text="#{employer.candidates.detail.invitation.select.job}">Chọn vị trí công việc</span>
                        </label>
                        <select class="form-select" id="jobPostSelect" name="jobPostId" required>
                            <option value="" th:text="#{employer.candidates.detail.invitation.select.job.placeholder}">-- Chọn vị trí công việc --</option>
                            <option th:each="job : ${employerJobPosts}" 
                                    th:value="${job.jobPostId}" 
                                    th:text="${job.jobTitle} + ' - ' + ${job.jobLocation}">
                                Job Title - Location
                            </option>
                        </select>
                        <div class="invalid-feedback" th:text="#{employer.candidates.detail.invitation.select.job.required}">
                            Vui lòng chọn vị trí công việc.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="invitationMessage" class="form-label">
                            <i class="bi bi-chat-text"></i> <span th:text="#{employer.candidates.detail.invitation.message}">Lời nhắn cá nhân</span>
                        </label>
                        <textarea class="form-control" id="invitationMessage" name="message" rows="4" 
                                  th:placeholder="#{employer.candidates.detail.invitation.message.placeholder}"
                                  th:text="#{employer.candidates.detail.invitation.message.default}">Chúng tôi rất ấn tượng với profile của bạn và muốn mời bạn ứng tuyển vào vị trí này tại công ty chúng tôi. Chúng tôi tin rằng bạn sẽ là một ứng viên tiềm năng cho vị trí này.</textarea>
                    </div>
                    
                    <input type="hidden" id="studentId" name="studentId" th:value="${student.studentId}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> <span th:text="#{employer.candidates.detail.invitation.cancel}">Hủy</span>
                </button>
                <button type="button" class="btn btn-primary" onclick="sendJobInvitation()" id="sendInvitationBtn">
                    <i class="bi bi-send"></i> <span th:text="#{employer.candidates.detail.invitation.send}">Gửi lời mời</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/language-dropdown.js}"></script>

<script>
// Job Invitation Modal JavaScript
let jobInvitationModal;

document.addEventListener('DOMContentLoaded', function() {
    jobInvitationModal = new bootstrap.Modal(document.getElementById('jobInvitationModal'));
});

function openJobInvitationModal() {
    // Reset form
    document.getElementById('jobInvitationForm').reset();
    
    // Reset validation classes
    resetValidation();
    
    // Show modal
    jobInvitationModal.show();
}

function resetValidation() {
    const form = document.getElementById('jobInvitationForm');
    const inputs = form.querySelectorAll('.form-control, .form-select');
    
    inputs.forEach(input => {
        input.classList.remove('is-invalid');
    });
    
    // Hide any existing alert messages
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
}

function validateForm() {
    const jobPostSelect = document.getElementById('jobPostSelect');
    const invitationMessage = document.getElementById('invitationMessage');
    
    let isValid = true;
    
    // Reset validation
    resetValidation();
    
    // Validate job post selection
    if (!jobPostSelect.value) {
        jobPostSelect.classList.add('is-invalid');
        isValid = false;
    }
    
    // Validate message (optional but should have some content)
    if (!invitationMessage.value.trim()) {
        invitationMessage.classList.add('is-invalid');
        isValid = false;
    }
    
    return isValid;
}

function showAlert(message, type = 'success') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    const modalBody = document.querySelector('#jobInvitationModal .modal-body');
    modalBody.insertAdjacentHTML('afterbegin', alertHtml);
}

function sendJobInvitation() {
    if (!validateForm()) {
        return;
    }
    
    const sendBtn = document.getElementById('sendInvitationBtn');
    const originalText = sendBtn.innerHTML;
    
    // Show loading state
    sendBtn.classList.add('loading');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span>' + /*[[#{employer.candidates.detail.invitation.sending}]]*/ 'Đang gửi...' + '</span>';
    
    // Get form data
    const formData = new FormData();
    formData.append('studentId', document.getElementById('studentId').value);
    formData.append('jobPostId', document.getElementById('jobPostSelect').value);
    formData.append('message', document.getElementById('invitationMessage').value);
    
    // Send request
    fetch('/Employer/SendJobInvitation', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
        return response.text();
    })
    .then(data => {
        // Success
        showAlert(data, 'success');
        
        // Reset form
        document.getElementById('jobInvitationForm').reset();
        
        // Auto close modal after 2 seconds
        setTimeout(() => {
            jobInvitationModal.hide();
        }, 2000);
    })
    .catch(error => {
        // Error
        showAlert(error.message || /*[[#{employer.candidates.detail.invitation.error}]]*/ 'Có lỗi xảy ra khi gửi lời mời', 'danger');
    })
    .finally(() => {
        // Reset button state
        sendBtn.classList.remove('loading');
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    });
}

// Handle modal close event
document.getElementById('jobInvitationModal').addEventListener('hidden.bs.modal', function () {
    // Reset form when modal is closed
    document.getElementById('jobInvitationForm').reset();
    resetValidation();
});
    </script>

    <!-- AI Chatbox Fragment -->
    <div th:replace="~{fragments/ai-chatbox :: ai-chatbox}"></div>
    
    <!-- Chat Notification Fragment -->
    <div th:replace="~{fragments/chat-notification :: chat-notification}"></div>
    <div th:replace="~{fragments/notification-bell :: notification-bell}"></div>

</body>
</html>