<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>

<!-- üö´ Ban User Modal -->
<div th:fragment="ban-modal" id="banModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="banModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="banModalLabel">
                    <i class="fas fa-ban"></i> Ban User Account
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <form id="banForm">
                <div class="modal-body">
                    <!-- User Info Display -->
                    <div class="alert alert-warning" id="userInfo">
                        <h6><i class="fas fa-exclamation-triangle"></i> Th√¥ng tin ng∆∞·ªùi d√πng</h6>
                        <p><strong>T√™n:</strong> <span id="userName">-</span></p>
                        <p><strong>Email:</strong> <span id="userEmail">-</span></p>
                        <p><strong>Role:</strong> <span id="userRole">-</span></p>
                    </div>
                    
                    <!-- Hidden User ID -->
                    <input type="hidden" id="banUserId" name="userId">
                    
                    <!-- Ban Reason -->
                    <div class="mb-3">
                        <label for="banReason" class="form-label">
                            <i class="fas fa-exclamation-circle text-danger"></i> 
                            L√Ω do ban <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="banReason" name="banReason" required>
                            <option value="">-- Ch·ªçn l√Ω do ban --</option>
                            <option value="SPAM">Spam n·ªôi dung</option>
                            <option value="INAPPROPRIATE_CONTENT">N·ªôi dung kh√¥ng ph√π h·ª£p</option>
                            <option value="FAKE_INFORMATION">Th√¥ng tin gi·∫£ m·∫°o</option>
                            <option value="HARASSMENT">Qu·∫•y r·ªëi ng∆∞·ªùi kh√°c</option>
                            <option value="FRAUD">L·ª´a ƒë·∫£o</option>
                            <option value="MULTIPLE_ACCOUNTS">T·∫°o nhi·ªÅu t√†i kho·∫£n</option>
                            <option value="VIOLATION_TERMS">Vi ph·∫°m ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng</option>
                            <option value="SYSTEM_ABUSE">L·∫°m d·ª•ng h·ªá th·ªëng</option>
                            <option value="OTHER">L√Ω do kh√°c</option>
                        </select>
                        <div class="invalid-feedback">
                            Vui l√≤ng ch·ªçn l√Ω do ban.
                        </div>
                    </div>
                    
                    <!-- Ban Description -->
                    <div class="mb-3">
                        <label for="banDescription" class="form-label">
                            <i class="fas fa-edit"></i> 
                            M√¥ t·∫£ chi ti·∫øt (t√πy ch·ªçn)
                        </label>
                        <textarea class="form-control" id="banDescription" name="banDescription" 
                                  rows="3" maxlength="1000" 
                                  placeholder="M√¥ t·∫£ chi ti·∫øt l√Ω do ban (t·ªëi ƒëa 1000 k√Ω t·ª±)..."></textarea>
                        <div class="form-text">
                            <span id="descriptionCount">0</span>/1000 k√Ω t·ª±
                        </div>
                    </div>
                    
                    <!-- Ban Duration Type -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-clock text-warning"></i> 
                            Lo·∫°i th·ªùi gian ban <span class="text-danger">*</span>
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="banDurationType" 
                                           id="temporaryBan" value="TEMPORARY" required>
                                    <label class="form-check-label" for="temporaryBan">
                                        <i class="fas fa-calendar-alt"></i> T·∫°m th·ªùi
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="banDurationType" 
                                           id="permanentBan" value="PERMANENT" required>
                                    <label class="form-check-label" for="permanentBan">
                                        <i class="fas fa-ban"></i> Vƒ©nh vi·ªÖn
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ban Duration Days (only for temporary) -->
                    <div class="mb-3" id="banDurationGroup" style="display: none;">
                        <label for="banDurationDays" class="form-label">
                            <i class="fas fa-calendar-day"></i> 
                            S·ªë ng√†y ban <span class="text-danger">*</span>
                        </label>
                        <div class="row">
                            <div class="col-md-8">
                                <input type="number" class="form-control" id="banDurationDays" 
                                       name="banDurationDays" min="1" max="365" 
                                       placeholder="Nh·∫≠p s·ªë ng√†y (1-365)">
                                <div class="invalid-feedback">
                                    Vui l√≤ng nh·∫≠p s·ªë ng√†y t·ª´ 1 ƒë·∫øn 365.
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="quickDuration">
                                    <option value="">Ch·ªçn nhanh</option>
                                    <option value="1">1 ng√†y</option>
                                    <option value="3">3 ng√†y</option>
                                    <option value="7">1 tu·∫ßn</option>
                                    <option value="14">2 tu·∫ßn</option>
                                    <option value="30">1 th√°ng</option>
                                    <option value="90">3 th√°ng</option>
                                    <option value="180">6 th√°ng</option>
                                    <option value="365">1 nƒÉm</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ban Summary -->
                    <div class="alert alert-info" id="banSummary" style="display: none;">
                        <h6><i class="fas fa-info-circle"></i> T√≥m t·∫Øt th√¥ng tin ban</h6>
                        <p><strong>L√Ω do:</strong> <span id="summaryReason">-</span></p>
                        <p><strong>Th·ªùi gian:</strong> <span id="summaryDuration">-</span></p>
                        <p class="mb-0"><strong>H√†nh ƒë·ªông:</strong> User s·∫Ω b·ªã kh√≥a t√†i kho·∫£n v√† nh·∫≠n email th√¥ng b√°o</p>
                    </div>
                    
                    <!-- Warning -->
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> C·∫£nh b√°o</h6>
                        <ul class="mb-0">
                            <li>H√†nh ƒë·ªông n√†y s·∫Ω kh√≥a t√†i kho·∫£n ng∆∞·ªùi d√πng ngay l·∫≠p t·ª©c</li>
                            <li>User s·∫Ω nh·∫≠n email th√¥ng b√°o chi ti·∫øt v·ªÅ vi·ªác b·ªã ban</li>
                            <li>ƒê·ªëi v·ªõi ban t·∫°m th·ªùi, t√†i kho·∫£n s·∫Ω t·ª± ƒë·ªông m·ªü kh√≥a khi h·∫øt h·∫°n</li>
                            <li>ƒê·ªëi v·ªõi ban vƒ©nh vi·ªÖn, ch·ªâ admin c√≥ th·ªÉ m·ªü kh√≥a</li>
                        </ul>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="submit" class="btn btn-danger" id="confirmBanBtn">
                        <i class="fas fa-ban"></i> X√°c nh·∫≠n Ban User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- üîì Unban Confirmation Modal -->
<div th:fragment="unbanModal" id="unbanModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="unbanModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="unbanModalLabel">
                    <i class="fas fa-unlock"></i> Unban User Account
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <div class="alert alert-info" id="unbanUserInfo">
                    <h6><i class="fas fa-user"></i> Th√¥ng tin ng∆∞·ªùi d√πng</h6>
                    <p><strong>T√™n:</strong> <span id="unbanUserName">-</span></p>
                    <p><strong>Email:</strong> <span id="unbanUserEmail">-</span></p>
                    <p><strong>Role:</strong> <span id="unbanUserRole">-</span></p>
                </div>
                
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> X√°c nh·∫≠n unban</h6>
                    <ul class="mb-0">
                        <li>T√†i kho·∫£n ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i ngay l·∫≠p t·ª©c</li>
                        <li>User s·∫Ω nh·∫≠n email th√¥ng b√°o v·ªÅ vi·ªác ƒë∆∞·ª£c m·ªü kh√≥a</li>
                        <li>User c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√† s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng</li>
                    </ul>
                </div>
                
                <input type="hidden" id="unbanUserId">
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> H·ªßy
                </button>
                <button type="button" class="btn btn-success" id="confirmUnbanBtn">
                    <i class="fas fa-unlock"></i> X√°c nh·∫≠n Unban
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Ban Modal JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const banModal = document.getElementById('banModal');
    const unbanModal = document.getElementById('unbanModal');
    const banForm = document.getElementById('banForm');
    const banDurationGroup = document.getElementById('banDurationGroup');
    const banSummary = document.getElementById('banSummary');
    
    // Event listeners for ban buttons are now handled in individual admin templates
    // to avoid conflicts and ensure proper data binding
    
    // Character counter for description
    const banDescription = document.getElementById('banDescription');
    const descriptionCount = document.getElementById('descriptionCount');
    
    banDescription?.addEventListener('input', function() {
        descriptionCount.textContent = this.value.length;
    });
    
    // Duration type change handler
    const durationRadios = document.querySelectorAll('input[name="banDurationType"]');
    durationRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'TEMPORARY') {
                banDurationGroup.style.display = 'block';
                document.getElementById('banDurationDays').required = true;
            } else {
                banDurationGroup.style.display = 'none';
                document.getElementById('banDurationDays').required = false;
                document.getElementById('banDurationDays').value = '';
            }
            updateBanSummary();
        });
    });
    
    // Quick duration selector
    const quickDuration = document.getElementById('quickDuration');
    quickDuration?.addEventListener('change', function() {
        if (this.value) {
            document.getElementById('banDurationDays').value = this.value;
            updateBanSummary();
        }
    });
    
    // Update ban summary
    function updateBanSummary() {
        const reason = document.getElementById('banReason');
        const durationType = document.querySelector('input[name="banDurationType"]:checked');
        const durationDays = document.getElementById('banDurationDays');
        
        if (reason.value && durationType) {
            const reasonText = reason.options[reason.selectedIndex].text;
            let durationText = durationType.value === 'PERMANENT' ? 'Vƒ©nh vi·ªÖn' : 
                              (durationDays.value ? durationDays.value + ' ng√†y' : 'Ch∆∞a x√°c ƒë·ªãnh');
            
            document.getElementById('summaryReason').textContent = reasonText;
            document.getElementById('summaryDuration').textContent = durationText;
            banSummary.style.display = 'block';
        } else {
            banSummary.style.display = 'none';
        }
    }
    
    // Form change listeners
    document.getElementById('banReason')?.addEventListener('change', updateBanSummary);
    document.getElementById('banDurationDays')?.addEventListener('input', updateBanSummary);
    
    // DEBUG: Check if banForm exists
    console.log('üîç DEBUG: Looking for banForm...');
    const banFormCheck = document.getElementById('banForm');
    console.log('üîç DEBUG: banForm found:', banFormCheck ? 'YES' : 'NO');
    
    // Ban form submission
    if (banForm) {
        console.log('üîç DEBUG: Adding submit event listener to banForm');
        banForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        console.log('üîç DEBUG: Form submitted from ban-modal.html!');
        
        const formData = new FormData(this);
        const banRequest = {
            userId: parseInt(formData.get('userId')) || window.currentBanUserId,
            banReason: formData.get('banReason'),
            banDescription: formData.get('banDescription'),
            banDurationType: formData.get('banDurationType'),
            banDurationDays: formData.get('banDurationDays') ? parseInt(formData.get('banDurationDays')) : null
        };
        
        console.log('üîç DEBUG: Ban request data from ban-modal:', banRequest);
        
        // Determine endpoint based on user role or use global variables
        const userRole = document.getElementById('userRole').textContent;
        const endpoint = (userRole === 'Student' || window.currentBanUserType === 'student') ? 
                        '/Admin/banStudentWithReason' : '/Admin/banEmployerWithReason';
        
        // Disable submit button
        const submitBtn = document.getElementById('confirmBanBtn');
        console.log('üîç DEBUG: Submit button found:', submitBtn ? 'YES' : 'NO');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
        
        // Submit ban request
        console.log('Sending ban request:', banRequest);
        console.log('Endpoint:', endpoint);
        
        // Use FormData for form submission (no CSRF token needed)
        const formDataToSend = new FormData();
        formDataToSend.append('userId', banRequest.userId);
        formDataToSend.append('banReason', banRequest.banReason);
        formDataToSend.append('banDescription', banRequest.banDescription || '');
        formDataToSend.append('banDurationType', banRequest.banDurationType);
        if (banRequest.banDurationDays) {
            formDataToSend.append('banDurationDays', banRequest.banDurationDays);
        }
        
        console.log('üîç DEBUG: Sending form data:', Object.fromEntries(formDataToSend));
        
        fetch(endpoint, {
            method: 'POST',
            body: formDataToSend
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // Show success message
                showAlert('success', data.message);
                
                // Close modal and refresh page
                bootstrap.Modal.getInstance(banModal).hide();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            console.error('Detailed error:', error);
            showAlert('danger', `C√≥ l·ªói x·∫£y ra: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-ban"></i> X√°c nh·∫≠n Ban User';
        });
        });
    } else {
        console.log('‚ùå DEBUG: banForm not found! Cannot add event listener.');
    }
    
    // Unban confirmation
    document.getElementById('confirmUnbanBtn')?.addEventListener('click', function() {
        const userId = document.getElementById('unbanUserId').value;
        const userRole = document.getElementById('unbanUserRole').textContent;
        const endpoint = userRole === 'Student' ? 
                        `/Admin/unbanStudentWithNotification/${userId}` : 
                        `/Admin/unbanEmployerWithNotification/${userId}`;
        
        // Disable button
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
        
        console.log('üîç DEBUG: Sending unban request to:', endpoint);
        
        fetch(endpoint, { 
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                bootstrap.Modal.getInstance(unbanModal).hide();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'C√≥ l·ªói x·∫£y ra khi unban user. Vui l√≤ng th·ª≠ l·∫°i.');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-unlock"></i> X√°c nh·∫≠n Unban';
        });
    });
    
    // Utility function to show alerts
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }
});

// Global fallback functions (if not defined in individual admin pages)
if (typeof openBanModal === 'undefined') {
    window.openBanModal = function(userId, userName, userEmail, userType) {
        console.log('üîç DEBUG: Global openBanModal called with:', {userId, userName, userEmail, userType});
        
        // Set global variables
        window.currentBanUserId = userId;
        window.currentBanUserName = userName;
        window.currentBanUserEmail = userEmail;
        window.currentBanUserType = userType;
        
        // Set form values
        document.getElementById('banUserId').value = userId;
        document.getElementById('userName').textContent = userName;
        document.getElementById('userEmail').textContent = userEmail || '-';
        document.getElementById('userRole').textContent = userType.charAt(0).toUpperCase() + userType.slice(1);
        
        // Update modal title with RED color
        const modalTitle = document.getElementById('banModalLabel');
        if (modalTitle) {
            modalTitle.innerHTML = `
                <i class="fas fa-ban"></i> 
                <span style="color: #dc3545; font-weight: bold;">
                    Ban ${userType.charAt(0).toUpperCase() + userType.slice(1)}: ${userName}
                </span>
            `;
        }
        
        // Reset form
        document.getElementById('banForm').reset();
        document.getElementById('banDurationGroup').style.display = 'none';
        document.getElementById('banSummary').style.display = 'none';
        document.getElementById('descriptionCount').textContent = '0';
        
        // Show modal
        new bootstrap.Modal(document.getElementById('banModal')).show();
    };
}

function openUnbanModal(userId, userName, userEmail, userRole) {
    document.getElementById('unbanUserId').value = userId;
    document.getElementById('unbanUserName').textContent = userName;
    document.getElementById('unbanUserEmail').textContent = userEmail;
    document.getElementById('unbanUserRole').textContent = userRole;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('unbanModal')).show();
}
</script>

</body>
</html> 