<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{forgotPassword.title}">Quên mật khẩu</title>
    <!-- Navbar CSS -->
    <link rel="stylesheet" th:href="@{/css/language-switcher.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarHome.css}" />
    <link rel="stylesheet" th:href="@{/css/navbar.css}" />
    <link rel="stylesheet" th:href="@{/css/navbarEnhanced.css}" />
    
    <!-- Other CSS -->
    <link rel="stylesheet" th:href="@{/css/login.css}" />
    <link rel="stylesheet" th:href="@{/css/registerEnhanced.css}" />
    <link rel="stylesheet" th:href="@{/css/forgotPasswordEnhanced.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

</head>
<body>
<div th:replace="~{navbar/navbarHome :: home}"></div>
<div class="page-container login-container">
    <h2 th:text="#{forgotPassword.heading}">Quên mật khẩu?</h2>
    <div class="subtitle" th:text="#{forgotPassword.otp.subtitle}">Vui lòng nhập OTP của bạn để đặt lại mật khẩu</div>

    <div th:if="${otpSuccess}" class="success-message" th:text="${otpSuccess}"></div>
    <div th:if="${otp_failed}" class="error-message" th:text="${otp_failed}"></div>
    <div th:if="${message}" class="error-message" th:text="${message}"></div>

    <form class="forgot-password-form" th:action="@{/ForgotPassword/VerifyOTP}" method="post">
        <div class="form-group otp-input-group">
            <input type="number" name="otp" th:placeholder="#{forgotPassword.otp.placeholder}" required>
            <button type="button" class="resend-otp-btn" title="Gửi lại OTP">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
        <button type="submit" class="content-btn content-btn-primary login-page-btn"><span class="icon-lock"></span><span th:text="#{forgotPassword.otp.confirm}">Xác nhận</span></button>
    </form>
</div>

<style>
/* OTP input group styling */
.otp-input-group {
    position: relative;
    display: flex;
    align-items: center;
}

.otp-input-group input {
    flex: 1;
    padding-right: 50px; /* Make space for the button */
}

.resend-otp-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: #6c757d;
    border: none;
    border-radius: 4px;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: bold;
}

.resend-otp-btn:hover {
    background: #5a6268;
    transform: translateY(-50%) scale(1.05);
}

.resend-otp-btn:active {
    transform: translateY(-50%) scale(0.95);
}

.resend-otp-btn:disabled {
    background: #adb5bd;
    cursor: not-allowed;
    transform: translateY(-50%);
}

.resend-otp-btn .spinner-small {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.forgot-password-form');
    const submitBtn = form.querySelector('button[type="submit"]');
    const resendBtn = document.querySelector('.resend-otp-btn');
    
    // Check if there's an active countdown in localStorage
    const lastResendTime = localStorage.getItem('otpResendTime');
    if (lastResendTime) {
        const timePassed = Math.floor((Date.now() - parseInt(lastResendTime)) / 1000);
        const remainingTime = 60 - timePassed;
        
        if (remainingTime > 0) {
            startCountdownWithTime(resendBtn, remainingTime);
        } else {
            localStorage.removeItem('otpResendTime');
        }
    }
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span>Đang xử lý...';
        form.classList.add('loading');
    });
    
    // Handle resend OTP
    resendBtn.addEventListener('click', function() {
        // Show loading state on resend button
        this.disabled = true;
        this.innerHTML = '<span class="spinner-small"></span>';
        
        // Simulate resend action (replace with actual endpoint)
        fetch('/ForgotPassword/ResendOTP', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'email=' + encodeURIComponent(getEmailFromSession()) // You need to implement this
        })
        .then(response => {
            if (response.ok) {
                // Show success feedback briefly
                this.innerHTML = '<i class="bi bi-check"></i>';
                this.style.background = '#28a745';
                
                setTimeout(() => {
                    // Save timestamp and start countdown
                    localStorage.setItem('otpResendTime', Date.now().toString());
                    startCountdown(this);
                }, 1000);
            } else {
                throw new Error('Failed to resend OTP');
            }
        })
        .catch(error => {
            // Show error feedback
            this.innerHTML = '<i class="bi bi-x"></i>';
            this.style.background = '#dc3545';
            setTimeout(() => {
                this.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                this.style.background = '#6c757d';
                this.disabled = false;
            }, 2000);
        });
    });
    
    function startCountdown(button) {
        startCountdownWithTime(button, 60);
    }
    
    function startCountdownWithTime(button, initialTime) {
        let countdown = initialTime;
        button.style.background = '#adb5bd';
        button.disabled = true;
        
        const countdownInterval = setInterval(() => {
            button.innerHTML = countdown;
            countdown--;
            
            if (countdown < 0) {
                clearInterval(countdownInterval);
                button.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                button.style.background = '#6c757d';
                button.disabled = false;
                localStorage.removeItem('otpResendTime');
            }
        }, 1000);
    }
    
    function getEmailFromSession() {
        // This should get email from session or hidden input
        // For now, return empty string - you need to implement this based on your backend
        return '';
    }
});
</script>
<script th:src="@{/js/languageSwitch.js}"></script>

</html>